<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin Dashboard - Harel Insurance Chatbot</title>
<style>
/* ── Reset & Base ─────────────────────────────────────────────── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --navy:    #003B7E;
  --azure:   #4A90D9;
  --gold:    #C6952B;
  --bg:      #0f1923;
  --surface: #162331;
  --card:    #1c2d3f;
  --border:  #26384d;
  --text:    #e2e8f0;
  --muted:   #8899aa;
  --green:   #22c55e;
  --red:     #ef4444;
  --amber:   #f59e0b;
  --radius:  8px;
}
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
}
a { color: var(--azure); text-decoration: none; }

/* ── Header ───────────────────────────────────────────────────── */
.header {
  background: linear-gradient(135deg, var(--navy), #00295a);
  padding: 16px 28px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 2px solid var(--gold);
}
.header h1 { font-size: 20px; font-weight: 600; letter-spacing: 0.5px; }
.header h1 span { color: var(--gold); }
.header-right { display: flex; align-items: center; gap: 16px; }
.overall-badge {
  padding: 4px 14px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.overall-badge.healthy { background: rgba(34,197,94,0.15); color: var(--green); border: 1px solid rgba(34,197,94,0.3); }
.overall-badge.degraded { background: rgba(245,158,11,0.15); color: var(--amber); border: 1px solid rgba(245,158,11,0.3); }
.overall-badge.down { background: rgba(239,68,68,0.15); color: var(--red); border: 1px solid rgba(239,68,68,0.3); }
.uptime { font-size: 12px; color: var(--muted); }
.chat-link {
  font-size: 13px;
  padding: 6px 14px;
  border-radius: 6px;
  background: rgba(74,144,217,0.15);
  border: 1px solid rgba(74,144,217,0.3);
  color: var(--azure);
}
.chat-link:hover { background: rgba(74,144,217,0.25); }

/* ── Layout ───────────────────────────────────────────────────── */
.dashboard { padding: 24px; display: flex; flex-direction: column; gap: 24px; max-width: 1400px; margin: 0 auto; }

/* ── Section titles ───────────────────────────────────────────── */
.section-title {
  font-size: 14px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--muted);
  margin-bottom: 12px;
}

/* ── Cards ────────────────────────────────────────────────────── */
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
}

/* ── Component Grid ───────────────────────────────────────────── */
.components-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 14px;
}
.component-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.component-card .comp-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.component-card .comp-name { font-size: 14px; font-weight: 600; }
.status-dot {
  width: 10px; height: 10px;
  border-radius: 50%;
  display: inline-block;
  flex-shrink: 0;
}
.status-dot.online  { background: var(--green); box-shadow: 0 0 6px rgba(34,197,94,0.5); }
.status-dot.offline { background: var(--red); box-shadow: 0 0 6px rgba(239,68,68,0.5); }
.status-dot.degraded { background: var(--amber); box-shadow: 0 0 6px rgba(245,158,11,0.5); }
.comp-detail { font-size: 12px; color: var(--muted); line-height: 1.4; }

/* ── Stats Row ────────────────────────────────────────────────── */
.stats-row {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 14px;
}
.stat-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  text-align: center;
}
.stat-value { font-size: 28px; font-weight: 700; color: var(--azure); }
.stat-label { font-size: 12px; color: var(--muted); margin-top: 4px; }

/* ── Documents Section ────────────────────────────────────────── */
.domain-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 10px;
}
.domain-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px;
  text-align: center;
}
.domain-card .domain-name { font-size: 13px; font-weight: 600; }
.domain-card .domain-he { font-size: 12px; color: var(--muted); direction: rtl; }
.domain-card .domain-count { font-size: 22px; font-weight: 700; color: var(--gold); margin-top: 6px; }
.domain-bar {
  height: 4px;
  background: var(--border);
  border-radius: 2px;
  margin-top: 8px;
  overflow: hidden;
}
.domain-bar-fill {
  height: 100%;
  background: var(--azure);
  border-radius: 2px;
  transition: width 0.4s ease;
}

/* ── Live Logs ────────────────────────────────────────────────── */
.logs-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}
.live-indicator {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: var(--green);
}
.live-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--green);
  animation: pulse 2s ease-in-out infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}
.logs-controls { display: flex; gap: 8px; }
.logs-controls button {
  background: var(--surface);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 5px 12px;
  border-radius: 6px;
  font-size: 12px;
  cursor: pointer;
}
.logs-controls button:hover { background: var(--border); }
.logs-controls button.active { border-color: var(--azure); color: var(--azure); }

.log-table-wrap {
  overflow-x: auto;
  max-height: 440px;
  overflow-y: auto;
  border: 1px solid var(--border);
  border-radius: var(--radius);
}
.log-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
.log-table thead {
  position: sticky;
  top: 0;
  z-index: 1;
}
.log-table th {
  background: var(--navy);
  color: var(--text);
  padding: 10px 12px;
  text-align: left;
  font-weight: 600;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
}
.log-table td {
  padding: 8px 12px;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
  max-width: 280px;
  overflow: hidden;
  text-overflow: ellipsis;
}
.log-table tbody tr { transition: background 0.15s; }
.log-table tbody tr:hover { background: rgba(74,144,217,0.08); }
.log-table tbody tr.new-row { animation: row-flash 1.2s ease; }
@keyframes row-flash {
  0% { background: rgba(74,144,217,0.25); }
  100% { background: transparent; }
}
.log-table tbody tr.error-row { background: rgba(239,68,68,0.08); }
.log-table tbody tr.fallback-row { background: rgba(245,158,11,0.06); }

.badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 600;
}
.badge-domain { background: rgba(74,144,217,0.15); color: var(--azure); }
.badge-confidence-high { background: rgba(34,197,94,0.15); color: var(--green); }
.badge-confidence-med  { background: rgba(245,158,11,0.15); color: var(--amber); }
.badge-confidence-low  { background: rgba(239,68,68,0.15); color: var(--red); }
.badge-error   { background: rgba(239,68,68,0.15); color: var(--red); }
.badge-pass    { background: rgba(34,197,94,0.15); color: var(--green); }
.badge-mode-rag      { background: rgba(99,102,241,0.15); color: #818CF8; }
.badge-mode-agentic  { background: rgba(245,158,11,0.15); color: var(--amber); }
.badge-mode-combined { background: rgba(34,197,94,0.15); color: var(--green); }
.mode-header-badge {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.4px;
}
.mode-header-badge.rag      { background: rgba(99,102,241,0.15); color: #818CF8; border: 1px solid rgba(99,102,241,0.3); }
.mode-header-badge.agentic  { background: rgba(245,158,11,0.15); color: var(--amber); border: 1px solid rgba(245,158,11,0.3); }
.mode-header-badge.combined { background: rgba(34,197,94,0.15); color: var(--green); border: 1px solid rgba(34,197,94,0.3); }

/* ── LLM Toggle ──────────────────────────────────────────────── */
.llm-toggle {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  color: var(--muted);
}
.llm-toggle select {
  background: var(--surface);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 12px;
  cursor: pointer;
  outline: none;
}
.llm-toggle select:hover { border-color: var(--azure); }
.llm-toggle select:disabled { opacity: 0.5; cursor: wait; }
.llm-toggle .llm-label { font-weight: 600; color: var(--text); }

.empty-state { text-align: center; padding: 40px; color: var(--muted); font-size: 14px; }

/* ── Prompts Panel ───────────────────────────────────────────── */
.prompts-list { display: flex; flex-direction: column; gap: 10px; }
.prompt-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  transition: border-color 0.2s;
}
.prompt-card.expanded { border-color: var(--azure); }
.prompt-card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  cursor: pointer;
  user-select: none;
}
.prompt-card-header:hover { background: rgba(74,144,217,0.06); }
.prompt-card-left { display: flex; align-items: center; gap: 12px; }
.prompt-card-name { font-size: 14px; font-weight: 600; }
.prompt-card-stage {
  font-size: 10px;
  padding: 2px 8px;
  border-radius: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  background: rgba(74,144,217,0.12);
  color: var(--azure);
}
.prompt-card-desc { font-size: 12px; color: var(--muted); }
.prompt-card-chevron {
  font-size: 14px;
  color: var(--muted);
  transition: transform 0.2s;
}
.prompt-card.expanded .prompt-card-chevron { transform: rotate(180deg); }
.prompt-card-body {
  display: none;
  padding: 0 16px 16px;
}
.prompt-card.expanded .prompt-card-body { display: block; }
.prompt-textarea {
  width: 100%;
  min-height: 180px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text);
  font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
  font-size: 12.5px;
  line-height: 1.6;
  padding: 12px 14px;
  resize: vertical;
  outline: none;
  tab-size: 2;
}
.prompt-textarea:focus { border-color: var(--azure); }
.prompt-actions {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 10px;
}
.prompt-actions .char-count { font-size: 11px; color: var(--muted); margin-right: auto; }
.prompt-btn {
  padding: 6px 16px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--text);
  transition: all 0.15s;
}
.prompt-btn:hover { border-color: var(--azure); }
.prompt-btn.save { background: rgba(74,144,217,0.15); border-color: var(--azure); color: var(--azure); }
.prompt-btn.save:hover { background: rgba(74,144,217,0.25); }
.prompt-btn:disabled { opacity: 0.4; cursor: default; }
.prompt-saved-msg { font-size: 12px; color: var(--green); opacity: 0; transition: opacity 0.3s; }
.prompt-saved-msg.show { opacity: 1; }

/* ── Agent Graph Visualization ───────────────────────────────── */
.graph-container {
  display: flex;
  align-items: center;
  gap: 0;
  padding: 20px 12px;
  overflow-x: auto;
  min-height: 90px;
}
.graph-node {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  flex-shrink: 0;
}
.graph-node-box {
  padding: 8px 16px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  white-space: nowrap;
  border: 2px solid;
  text-align: center;
  min-width: 80px;
}
.graph-node-box.process {
  background: rgba(74,144,217,0.12);
  border-color: var(--azure);
  color: var(--azure);
}
.graph-node-box.decision {
  background: rgba(245,158,11,0.12);
  border-color: var(--amber);
  color: var(--amber);
  border-radius: 4px;
  transform: rotate(0deg);
}
.graph-node-box.control {
  background: rgba(129,140,248,0.12);
  border-color: #818CF8;
  color: #818CF8;
  border-style: dashed;
}
.graph-node-box.terminal {
  background: rgba(34,197,94,0.1);
  border-color: var(--green);
  color: var(--green);
  border-radius: 20px;
}
.graph-node-box.terminal.fallback-node {
  background: rgba(239,68,68,0.1);
  border-color: var(--red);
  color: var(--red);
}
.graph-arrow {
  display: flex;
  flex-direction: column;
  align-items: center;
  flex-shrink: 0;
  gap: 2px;
}
.graph-arrow-line {
  width: 32px;
  height: 2px;
  background: var(--border);
  position: relative;
}
.graph-arrow-line::after {
  content: '';
  position: absolute;
  right: -1px;
  top: -4px;
  border: 5px solid transparent;
  border-left: 6px solid var(--border);
}
.graph-arrow-label {
  font-size: 9px;
  color: var(--muted);
  white-space: nowrap;
}
.graph-legend {
  display: flex;
  gap: 16px;
  padding: 8px 16px 0;
  font-size: 11px;
  color: var(--muted);
}
.graph-legend-item { display: flex; align-items: center; gap: 5px; }
.graph-legend-dot {
  width: 10px; height: 10px;
  border-radius: 3px;
  border: 2px solid;
}
.graph-legend-dot.process { border-color: var(--azure); background: rgba(74,144,217,0.12); }
.graph-legend-dot.decision { border-color: var(--amber); background: rgba(245,158,11,0.12); }
.graph-legend-dot.control { border-color: #818CF8; background: rgba(129,140,248,0.12); border-style: dashed; }
.graph-legend-dot.terminal { border-color: var(--green); background: rgba(34,197,94,0.1); border-radius: 10px; }
/* Retry arc */
.graph-retry-row {
  display: flex;
  align-items: flex-start;
  justify-content: center;
  padding: 0 12px 12px;
}
.graph-retry-arc {
  font-size: 10px;
  color: #818CF8;
  text-align: center;
  border-bottom: 2px dashed rgba(129,140,248,0.4);
  padding-bottom: 4px;
}
.graph-node-box { cursor: pointer; transition: all 0.15s; }
.graph-node-box:hover { filter: brightness(1.3); transform: scale(1.05); }
.graph-node-box.selected { box-shadow: 0 0 0 3px rgba(74,144,217,0.4); transform: scale(1.08); }

/* Node detail panel */
.node-detail-panel {
  display: none;
  margin-top: 12px;
  padding: 16px 20px;
  background: var(--surface);
  border: 1px solid var(--azure);
  border-radius: var(--radius);
  animation: fadeSlide 0.2s ease;
}
@keyframes fadeSlide {
  from { opacity: 0; transform: translateY(-6px); }
  to { opacity: 1; transform: translateY(0); }
}
.node-detail-panel.visible { display: block; }
.node-detail-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 14px;
}
.node-detail-title { font-size: 16px; font-weight: 700; color: var(--text); }
.node-detail-close {
  background: none;
  border: 1px solid var(--border);
  color: var(--muted);
  width: 28px; height: 28px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  display: flex; align-items: center; justify-content: center;
}
.node-detail-close:hover { color: var(--text); border-color: var(--azure); }
.node-detail-columns {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}
@media (max-width: 768px) {
  .node-detail-columns { grid-template-columns: 1fr; }
}
.node-detail-section { display: flex; flex-direction: column; gap: 6px; }
.node-detail-section-title {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--muted);
}
.node-detail-steps {
  list-style: none;
  padding: 0;
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.node-detail-steps li {
  font-size: 13px;
  color: var(--text);
  line-height: 1.5;
  padding-left: 16px;
  position: relative;
}
.node-detail-steps li::before {
  content: '';
  position: absolute;
  left: 0;
  top: 7px;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--azure);
}
.node-detail-steps li.sub-step { padding-left: 30px; color: var(--muted); font-size: 12px; }
.node-detail-steps li.sub-step::before { left: 14px; width: 4px; height: 4px; background: var(--border); }
.node-detail-prompt-link {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 5px 12px;
  background: rgba(74,144,217,0.08);
  border: 1px solid rgba(74,144,217,0.2);
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  color: var(--azure);
  cursor: pointer;
  transition: all 0.15s;
}
.node-detail-prompt-link:hover { background: rgba(74,144,217,0.15); border-color: var(--azure); }
.node-detail-prompts-list { display: flex; flex-wrap: wrap; gap: 6px; }
.node-detail-state {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}
.state-key {
  font-family: 'SF Mono', 'Fira Code', monospace;
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 4px;
  background: var(--card);
  border: 1px solid var(--border);
  color: var(--text);
}
.state-key.read { border-left: 3px solid var(--azure); }
.state-key.write { border-left: 3px solid var(--green); }

/* ── Expandable Detail Row ──────────────────────────────────── */
.log-table tbody tr.clickable { cursor: pointer; }
.log-table tbody tr.clickable:hover { background: rgba(74,144,217,0.12); }

.detail-row td { padding: 0 !important; border-bottom: 2px solid var(--azure); }
.detail-inner {
  padding: 16px 20px;
  background: var(--surface);
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.detail-section-title {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--muted);
  margin-bottom: 4px;
}

.detail-answer {
  font-size: 14px;
  line-height: 1.7;
  color: var(--text);
  white-space: pre-wrap;
  direction: rtl;
  text-align: right;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px 16px;
  max-height: 300px;
  overflow-y: auto;
}

.detail-citations-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.detail-cit-card {
  display: flex;
  gap: 12px;
  padding: 10px 14px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
}

.detail-cit-num {
  width: 24px;
  height: 24px;
  background: rgba(74,144,217,0.15);
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 700;
  color: var(--azure);
  flex-shrink: 0;
}

.detail-cit-body { flex: 1; min-width: 0; }
.detail-cit-file {
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  word-break: break-all;
}
.detail-cit-page { font-size: 12px; color: var(--muted); margin-top: 2px; }
.detail-cit-title { font-size: 12px; color: var(--azure); margin-top: 2px; }
.detail-cit-text {
  font-size: 12px;
  color: var(--muted);
  margin-top: 4px;
  line-height: 1.5;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.detail-meta-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 8px;
}

.detail-meta-item {
  padding: 8px 12px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
}

.detail-meta-label { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
.detail-meta-value { font-size: 13px; color: var(--text); font-weight: 600; margin-top: 2px; }

.detail-loading {
  text-align: center;
  padding: 20px;
  color: var(--muted);
  font-size: 13px;
}

/* ── Traces Panel ────────────────────────────────────────────── */
.traces-table-wrap {
  overflow-x: auto;
  max-height: 500px;
  overflow-y: auto;
  border: 1px solid var(--border);
  border-radius: var(--radius);
}
.traces-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
.traces-table thead { position: sticky; top: 0; z-index: 1; }
.traces-table th {
  background: var(--navy);
  color: var(--text);
  padding: 10px 12px;
  text-align: left;
  font-weight: 600;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
}
.traces-table td {
  padding: 8px 12px;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
  max-width: 300px;
  overflow: hidden;
  text-overflow: ellipsis;
}
.traces-table tbody tr { transition: background 0.15s; cursor: pointer; }
.traces-table tbody tr:hover { background: rgba(74,144,217,0.08); }

.trace-detail-row td { padding: 0 !important; border-bottom: 2px solid var(--azure); }
.trace-detail-inner {
  padding: 16px 20px;
  background: var(--surface);
  display: flex;
  flex-direction: column;
  gap: 16px;
}
.trace-config-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}
.trace-config-tag {
  padding: 4px 10px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 12px;
}
.trace-config-tag .cfg-key { color: var(--muted); }
.trace-config-tag .cfg-val { color: var(--text); font-weight: 600; margin-left: 4px; }

.trace-calls-timeline { display: flex; flex-direction: column; gap: 0; }
.trace-call-card {
  display: flex;
  gap: 16px;
  padding: 14px 16px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 0;
  position: relative;
}
.trace-call-card:first-child { border-radius: var(--radius) var(--radius) 0 0; }
.trace-call-card:last-child { border-radius: 0 0 var(--radius) var(--radius); }
.trace-call-card:only-child { border-radius: var(--radius); }
.trace-call-card + .trace-call-card { border-top: none; }

.trace-call-index {
  width: 28px; height: 28px;
  background: rgba(74,144,217,0.15);
  border-radius: 6px;
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 700; color: var(--azure);
  flex-shrink: 0;
}
.trace-call-body { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 8px; }
.trace-call-header { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
.trace-call-node {
  font-size: 13px; font-weight: 700; color: var(--text);
}
.trace-call-meta {
  font-size: 11px; color: var(--muted);
  display: flex; gap: 12px; flex-wrap: wrap;
}
.trace-call-meta span { white-space: nowrap; }

.trace-call-prompt-box,
.trace-call-response-box {
  font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
  font-size: 11.5px;
  line-height: 1.5;
  padding: 10px 12px;
  border-radius: 6px;
  border: 1px solid var(--border);
  max-height: 200px;
  overflow-y: auto;
  white-space: pre-wrap;
  word-break: break-word;
}
.trace-call-prompt-box {
  background: rgba(74,144,217,0.06);
  color: var(--text);
}
.trace-call-response-box {
  background: rgba(34,197,94,0.06);
  color: var(--text);
}
.trace-call-label {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.6px;
  color: var(--muted);
  margin-bottom: 2px;
}
.trace-call-toggle {
  background: none;
  border: 1px solid var(--border);
  color: var(--azure);
  padding: 3px 10px;
  border-radius: 4px;
  font-size: 11px;
  cursor: pointer;
  white-space: nowrap;
}
.trace-call-toggle:hover { background: rgba(74,144,217,0.1); }

.trace-result-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 8px;
}
.trace-result-item {
  padding: 8px 12px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
}
.trace-result-label { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
.trace-result-value { font-size: 13px; color: var(--text); font-weight: 600; margin-top: 2px; }

/* ── Responsive ───────────────────────────────────────────────── */
@media (max-width: 768px) {
  .header { flex-direction: column; gap: 10px; text-align: center; }
  .components-grid { grid-template-columns: 1fr 1fr; }
  .stats-row { grid-template-columns: 1fr 1fr; }
  .domain-grid { grid-template-columns: 1fr 1fr; }
}
</style>
</head>
<body>

<!-- ─── Header ─────────────────────────────────────────────────── -->
<div class="header">
  <h1>Harel Insurance Chatbot <span>/ Admin</span></h1>
  <div class="header-right">
    <span class="overall-badge" id="overallBadge">loading...</span>
    <div class="llm-toggle">
      <span class="llm-label">Mode:</span>
      <select id="modeSelect" onchange="switchMode(this.value)">
        <option value="rag">RAG</option>
        <option value="agentic">Library</option>
        <option value="combined">Combined</option>
      </select>
    </div>
    <div class="llm-toggle">
      <span class="llm-label">LLM:</span>
      <select id="llmSelect" onchange="switchLLM(this.value)">
        <option value="ollama">Ollama</option>
        <option value="claude">Claude</option>
        <option value="gemini">Gemini</option>
      </select>
    </div>
    <span class="uptime" id="uptimeText"></span>
    <a href="/explorer-ui" class="chat-link">Explorer</a>
    <a href="/tester-ui" class="chat-link">Tester</a>
    <a href="/ui" class="chat-link">Chat UI</a>
  </div>
</div>

<!-- ─── Dashboard ──────────────────────────────────────────────── -->
<div class="dashboard">

  <!-- System Components -->
  <div>
    <div class="section-title">System Components</div>
    <div class="components-grid" id="componentsGrid">
      <!-- Filled by JS -->
    </div>
  </div>

  <!-- Agent Graph -->
  <div>
    <div class="section-title">Agent Pipeline</div>
    <div class="card" style="padding: 0;">
      <div class="graph-container" id="graphContainer">
        <div class="empty-state">Loading graph...</div>
      </div>
      <div class="graph-legend" id="graphLegend"></div>
      <div class="node-detail-panel" id="nodeDetailPanel"></div>
    </div>
  </div>

  <!-- Query Stats -->
  <div>
    <div class="section-title">Query Statistics</div>
    <div class="stats-row" id="statsRow">
      <!-- Filled by JS -->
    </div>
  </div>

  <!-- LLM Traces -->
  <div>
    <div class="logs-header">
      <div style="display:flex;align-items:center;gap:16px;">
        <div class="section-title" style="margin-bottom:0">LLM Call Traces</div>
      </div>
      <div class="logs-controls">
        <button onclick="fetchTraces()">Refresh</button>
      </div>
    </div>
    <div class="card" style="padding:0;">
      <div class="traces-table-wrap">
        <table class="traces-table">
          <thead>
            <tr>
              <th>Time</th>
              <th>Query</th>
              <th>Mode</th>
              <th>LLM</th>
              <th>LLM Calls</th>
              <th>Duration</th>
            </tr>
          </thead>
          <tbody id="tracesTableBody">
          </tbody>
        </table>
        <div class="empty-state" id="tracesEmptyState">No traces recorded yet. Traces appear after queries are processed.</div>
      </div>
    </div>
  </div>

  <!-- Live Query Logs -->
  <div>
    <div class="logs-header">
      <div style="display:flex;align-items:center;gap:16px;">
        <div class="section-title" style="margin-bottom:0">Live Query Logs</div>
        <div class="live-indicator" id="liveIndicator">
          <span class="live-dot"></span> <span id="liveText">Connecting...</span>
        </div>
      </div>
      <div class="logs-controls">
        <button id="btnAutoscroll" class="active" onclick="toggleAutoscroll()">Auto-scroll</button>
        <button onclick="clearLogs()">Clear</button>
      </div>
    </div>
    <div class="card" style="padding:0;">
      <div class="log-table-wrap" id="logTableWrap">
        <table class="log-table">
          <thead>
            <tr>
              <th>Time</th>
              <th>Query</th>
              <th>Mode</th>
              <th>Language</th>
              <th>Domain</th>
              <th>Docs Retrieved</th>
              <th>Docs Graded</th>
              <th>Citations</th>
              <th>Confidence</th>
              <th>Quality</th>
              <th>Duration</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="logTableBody">
          </tbody>
        </table>
        <div class="empty-state" id="emptyState">No queries recorded yet. Logs will appear here in real time.</div>
      </div>
    </div>
  </div>

  <!-- Prompt Templates -->
  <div>
    <div class="section-title">Prompt Templates</div>
    <div class="card">
      <div class="prompts-list" id="promptsList">
        <div class="empty-state">Loading prompts...</div>
      </div>
    </div>
  </div>

  <!-- Document Stats -->
  <div>
    <div class="section-title">Documents Analyzed</div>
    <div class="card">
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px;">
        <div>
          <span style="font-size:32px;font-weight:700;color:var(--gold);" id="totalChunks">--</span>
          <span style="font-size:13px;color:var(--muted);margin-left:6px;">total chunks indexed</span>
        </div>
      </div>
      <div class="domain-grid" id="domainGrid">
        <!-- Filled by JS -->
      </div>
    </div>
  </div>
</div>

<script>
/* ── Config ──────────────────────────────────────────────────── */
const API = window.location.origin;
let autoscroll = true;
let sseRetryTimeout = null;

/* ── Helpers ─────────────────────────────────────────────────── */
function formatTime(ts) {
  const d = new Date(ts * 1000);
  return d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}
function formatDuration(ms) {
  if (ms < 1000) return ms.toFixed(0) + 'ms';
  return (ms / 1000).toFixed(1) + 's';
}
function formatUptime(sec) {
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  const s = Math.floor(sec % 60);
  if (h > 0) return `${h}h ${m}m`;
  if (m > 0) return `${m}m ${s}s`;
  return `${s}s`;
}
function confBadge(c) {
  if (c >= 0.8) return `<span class="badge badge-confidence-high">${(c * 100).toFixed(0)}%</span>`;
  if (c >= 0.5) return `<span class="badge badge-confidence-med">${(c * 100).toFixed(0)}%</span>`;
  return `<span class="badge badge-confidence-low">${(c * 100).toFixed(0)}%</span>`;
}
function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

/* ── Fetch System Status ─────────────────────────────────────── */
async function fetchStatus() {
  try {
    const res = await fetch(`${API}/admin/status`);
    const data = await res.json();
    renderComponents(data.components);

    // Overall badge
    const badge = document.getElementById('overallBadge');
    badge.textContent = data.overall;
    badge.className = 'overall-badge ' + data.overall;

    // Uptime
    document.getElementById('uptimeText').textContent = 'Uptime: ' + formatUptime(data.uptime_seconds);
  } catch (e) {
    document.getElementById('overallBadge').textContent = 'unreachable';
    document.getElementById('overallBadge').className = 'overall-badge down';
  }

}

function renderComponents(components) {
  const grid = document.getElementById('componentsGrid');
  grid.innerHTML = components.map(c => `
    <div class="component-card">
      <div class="comp-header">
        <span class="comp-name">${escapeHtml(c.name)}</span>
        <span class="status-dot ${c.status}"></span>
      </div>
      <div class="comp-detail">${escapeHtml(c.detail)}</div>
    </div>
  `).join('');
}

/* ── Inference LLM Toggle ────────────────────────────────────── */
async function fetchInferenceLLM() {
  try {
    const res = await fetch(`${API}/admin/inference-llm`);
    const data = await res.json();
    document.getElementById('llmSelect').value = data.llm;
  } catch (e) { /* ignore */ }
}

async function switchLLM(llm) {
  const sel = document.getElementById('llmSelect');
  sel.disabled = true;
  try {
    const res = await fetch(`${API}/admin/inference-llm`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ llm }),
    });
    const data = await res.json();
    if (data.error) {
      alert(data.error);
      await fetchInferenceLLM(); // revert select
    } else {
      // Refresh status to reflect the new LLM component
      await fetchStatus();
    }
  } catch (e) {
    alert('Failed to switch LLM');
    await fetchInferenceLLM();
  } finally {
    sel.disabled = false;
  }
}

/* ── Retrieval Mode Toggle ───────────────────────────────────── */
async function fetchRetrievalMode() {
  try {
    const res = await fetch(`${API}/admin/retrieval-mode`);
    const data = await res.json();
    document.getElementById('modeSelect').value = data.mode;
  } catch (e) { /* ignore */ }
}

async function switchMode(mode) {
  const sel = document.getElementById('modeSelect');
  sel.disabled = true;
  try {
    const res = await fetch(`${API}/admin/retrieval-mode`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mode }),
    });
    const data = await res.json();
    if (data.error) {
      alert(data.error);
      await fetchRetrievalMode();
    } else {
      await fetchStatus();
      await fetchGraphTopology();
    }
  } catch (e) {
    alert('Failed to switch retrieval mode');
    await fetchRetrievalMode();
  } finally {
    sel.disabled = false;
  }
}

/* ── Fetch Query Stats ───────────────────────────────────────── */
async function fetchQueryStats() {
  try {
    const res = await fetch(`${API}/admin/query-stats`);
    const data = await res.json();
    renderStats(data);
  } catch (e) {
    // silently retry on next interval
  }
}

function renderStats(s) {
  document.getElementById('statsRow').innerHTML = `
    <div class="stat-card">
      <div class="stat-value">${s.total_queries}</div>
      <div class="stat-label">Total Queries</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" style="color:var(--green)">${s.total_queries - s.total_errors - s.total_fallbacks}</div>
      <div class="stat-label">Successful</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" style="color:var(--amber)">${s.total_fallbacks}</div>
      <div class="stat-label">Fallbacks</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" style="color:var(--red)">${s.total_errors}</div>
      <div class="stat-label">Errors</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${formatDuration(s.avg_duration_ms)}</div>
      <div class="stat-label">Avg Duration</div>
    </div>
  `;
}

/* ── Fetch Document Stats ────────────────────────────────────── */
async function fetchDocStats() {
  try {
    const res = await fetch(`${API}/admin/documents`);
    const data = await res.json();
    document.getElementById('totalChunks').textContent = data.total_chunks.toLocaleString();
    renderDomains(data.domains, data.total_chunks);
  } catch (e) {
    // silently retry
  }
}

const domainIcons = {
  car: '&#128663;', life: '&#10084;&#65039;', travel: '&#9992;&#65039;',
  health: '&#127973;', dental: '&#129463;', mortgage: '&#127968;',
  business: '&#128188;', apartment: '&#127970;'
};

function renderDomains(domains, total) {
  const max = Math.max(...domains.map(d => d.count), 1);
  document.getElementById('domainGrid').innerHTML = domains.map(d => `
    <div class="domain-card">
      <div class="domain-name">${domainIcons[d.domain] || ''} ${escapeHtml(d.domain)}</div>
      <div class="domain-he">${escapeHtml(d.domain_he)}</div>
      <div class="domain-count">${d.count.toLocaleString()}</div>
      <div class="domain-bar"><div class="domain-bar-fill" style="width:${((d.count / max) * 100).toFixed(1)}%"></div></div>
    </div>
  `).join('');
}

/* ── Agent Graph ─────────────────────────────────────────────── */
let graphData = null;  // cached graph topology
let selectedNodeId = null;

async function fetchGraphTopology() {
  try {
    const res = await fetch(`${API}/admin/graph-topology`);
    graphData = await res.json();
    renderGraph(graphData);
  } catch (e) {
    document.getElementById('graphContainer').innerHTML =
      '<div class="empty-state">Failed to load graph.</div>';
  }
}

function renderGraph(data) {
  const container = document.getElementById('graphContainer');
  const legend = document.getElementById('graphLegend');

  const nodes = data.nodes;
  const edges = data.edges;
  const nodeMap = {};
  nodes.forEach(n => nodeMap[n.id] = n);

  // Find main flow path by following primary edges
  const mainPath = [];
  const mainEdges = [];
  const visited = new Set();

  let current = nodes[0].id;
  while (current && !visited.has(current)) {
    visited.add(current);
    mainPath.push(current);
    const outEdges = edges.filter(e => e.from === current);
    const primary = outEdges.find(e => e.to !== 'fallback' && e.to !== 'increment_retry' && e.to !== 'end')
      || outEdges.find(e => e.to === 'end')
      || outEdges[0];
    if (primary) {
      mainEdges.push(primary);
      if (primary.to === 'end') {
        mainPath.push('end');
        break;
      }
      current = primary.to;
    } else {
      break;
    }
  }

  // Render nodes along the main path
  let html = '';
  for (let i = 0; i < mainPath.length; i++) {
    const nodeId = mainPath[i];
    const node = nodeMap[nodeId];
    if (!node) continue;

    const isFallback = nodeId === 'fallback';
    const sel = selectedNodeId === nodeId ? ' selected' : '';
    html += `<div class="graph-node">
      <div class="graph-node-box ${node.type}${isFallback ? ' fallback-node' : ''}${sel}" onclick="selectNode('${nodeId}')">${escapeHtml(node.label)}</div>
    </div>`;

    if (i < mainPath.length - 1) {
      const edge = mainEdges[i];
      const label = edge && edge.label ? edge.label : '';
      html += `<div class="graph-arrow">
        <div class="graph-arrow-line"></div>
        ${label ? `<div class="graph-arrow-label">${escapeHtml(label)}</div>` : ''}
      </div>`;
    }
  }

  container.innerHTML = html;

  legend.innerHTML = `
    <div class="graph-legend-item"><div class="graph-legend-dot process"></div> Process</div>
    <div class="graph-legend-item"><div class="graph-legend-dot decision"></div> Decision</div>
    <div class="graph-legend-item"><div class="graph-legend-dot control"></div> Retry loop</div>
    <div class="graph-legend-item"><div class="graph-legend-dot terminal"></div> Terminal</div>
    <div style="margin-left:auto;font-size:11px;color:var(--muted)">Mode: <strong style="color:var(--text)">${data.mode}</strong></div>
  `;
}

function selectNode(nodeId) {
  const panel = document.getElementById('nodeDetailPanel');

  // Toggle off if same node clicked
  if (selectedNodeId === nodeId) {
    selectedNodeId = null;
    panel.classList.remove('visible');
    renderGraph(graphData);
    return;
  }

  selectedNodeId = nodeId;
  renderGraph(graphData);  // re-render to update selected state

  // Find node data
  const node = graphData.nodes.find(n => n.id === nodeId);
  if (!node) return;

  const steps = (node.steps || []);
  const prompts = (node.prompts || []);
  const reads = (node.reads || []);
  const writes = (node.writes || []);

  // Build steps list
  const stepsHtml = steps.map(s => {
    const isSub = s.startsWith('  ');
    const text = s.replace(/^\s+/, '');
    return `<li class="${isSub ? 'sub-step' : ''}">${escapeHtml(text)}</li>`;
  }).join('');

  // Build prompts links
  let promptsHtml = '<span style="font-size:12px;color:var(--muted)">None (no LLM call)</span>';
  if (prompts.length > 0) {
    // Look up prompt names from promptsData
    promptsHtml = '<div class="node-detail-prompts-list">' + prompts.map(pid => {
      const pData = promptsData.find(p => p.id === pid);
      const name = pData ? pData.name : pid;
      return `<div class="node-detail-prompt-link" onclick="scrollToPrompt('${pid}')">${escapeHtml(name)}</div>`;
    }).join('') + '</div>';
  }

  // Build state keys
  const readsHtml = reads.length
    ? reads.map(k => `<span class="state-key read">${escapeHtml(k)}</span>`).join('')
    : '<span style="font-size:12px;color:var(--muted)">None</span>';
  const writesHtml = writes.length
    ? writes.map(k => `<span class="state-key write">${escapeHtml(k)}</span>`).join('')
    : '<span style="font-size:12px;color:var(--muted)">None</span>';

  panel.innerHTML = `
    <div class="node-detail-header">
      <div class="node-detail-title">${escapeHtml(node.label)}</div>
      <button class="node-detail-close" onclick="selectNode('${nodeId}')">&#10005;</button>
    </div>
    <div class="node-detail-columns">
      <div class="node-detail-section">
        <div class="node-detail-section-title">Steps</div>
        <ul class="node-detail-steps">${stepsHtml}</ul>
      </div>
      <div class="node-detail-section" style="gap:14px;">
        <div>
          <div class="node-detail-section-title">Prompts Used</div>
          <div style="margin-top:6px;">${promptsHtml}</div>
        </div>
        <div>
          <div class="node-detail-section-title">Reads from state</div>
          <div class="node-detail-state" style="margin-top:4px;">${readsHtml}</div>
        </div>
        <div>
          <div class="node-detail-section-title">Writes to state</div>
          <div class="node-detail-state" style="margin-top:4px;">${writesHtml}</div>
        </div>
      </div>
    </div>
  `;
  panel.classList.add('visible');
}

function scrollToPrompt(promptId) {
  const card = document.getElementById('prompt-card-' + promptId);
  if (!card) return;
  // Expand it if collapsed
  if (!card.classList.contains('expanded')) {
    card.classList.add('expanded');
  }
  card.scrollIntoView({ behavior: 'smooth', block: 'center' });
  // Flash highlight
  card.style.borderColor = 'var(--azure)';
  card.style.boxShadow = '0 0 0 3px rgba(74,144,217,0.3)';
  setTimeout(() => {
    card.style.borderColor = '';
    card.style.boxShadow = '';
  }, 2000);
}

/* ── Prompts Panel ───────────────────────────────────────────── */
let promptsData = [];  // cached prompt data
let promptOriginals = {};  // original content for revert

async function fetchPrompts() {
  try {
    const res = await fetch(`${API}/admin/prompts`);
    promptsData = await res.json();
    renderPrompts();
  } catch (e) {
    document.getElementById('promptsList').innerHTML =
      '<div class="empty-state">Failed to load prompts.</div>';
  }
}

const stageColors = {
  generator: '#22c55e',
  router: '#f59e0b',
  query_analyzer: '#818CF8',
  grader: '#4A90D9',
  quality: '#ef4444',
  navigator: '#C6952B',
};

function renderPrompts() {
  const list = document.getElementById('promptsList');
  if (!promptsData.length) {
    list.innerHTML = '<div class="empty-state">No prompts found.</div>';
    return;
  }
  list.innerHTML = promptsData.map(p => {
    promptOriginals[p.id] = p.content;
    const stageColor = stageColors[p.stage] || 'var(--azure)';
    return `
    <div class="prompt-card" id="prompt-card-${p.id}">
      <div class="prompt-card-header" onclick="togglePrompt('${p.id}')">
        <div class="prompt-card-left">
          <span class="prompt-card-name">${escapeHtml(p.name)}</span>
          <span class="prompt-card-stage" style="background:${stageColor}22;color:${stageColor}">${escapeHtml(p.stage)}</span>
          <span class="prompt-card-desc">${escapeHtml(p.description)}</span>
        </div>
        <span class="prompt-card-chevron">&#9660;</span>
      </div>
      <div class="prompt-card-body">
        <textarea class="prompt-textarea" id="prompt-text-${p.id}"
          oninput="onPromptEdit('${p.id}')">${escapeHtml(p.content)}</textarea>
        <div class="prompt-actions">
          <span class="char-count" id="prompt-chars-${p.id}">${p.content.length} chars</span>
          <span class="prompt-saved-msg" id="prompt-saved-${p.id}">Saved</span>
          <button class="prompt-btn" onclick="revertPrompt('${p.id}')">Revert</button>
          <button class="prompt-btn save" id="prompt-save-${p.id}" onclick="savePrompt('${p.id}')" disabled>Save</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function togglePrompt(id) {
  const card = document.getElementById('prompt-card-' + id);
  card.classList.toggle('expanded');
}

function onPromptEdit(id) {
  const textarea = document.getElementById('prompt-text-' + id);
  const chars = document.getElementById('prompt-chars-' + id);
  const saveBtn = document.getElementById('prompt-save-' + id);
  const savedMsg = document.getElementById('prompt-saved-' + id);
  chars.textContent = textarea.value.length + ' chars';
  saveBtn.disabled = textarea.value === promptOriginals[id];
  savedMsg.classList.remove('show');
}

function revertPrompt(id) {
  const textarea = document.getElementById('prompt-text-' + id);
  textarea.value = promptOriginals[id];
  onPromptEdit(id);
}

async function savePrompt(id) {
  const textarea = document.getElementById('prompt-text-' + id);
  const saveBtn = document.getElementById('prompt-save-' + id);
  const savedMsg = document.getElementById('prompt-saved-' + id);
  saveBtn.disabled = true;
  saveBtn.textContent = 'Saving...';

  try {
    const res = await fetch(`${API}/admin/prompts/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content: textarea.value }),
    });
    const data = await res.json();
    if (data.updated) {
      promptOriginals[id] = textarea.value;
      savedMsg.classList.add('show');
      setTimeout(() => savedMsg.classList.remove('show'), 2500);
    } else {
      alert('Failed to save prompt.');
    }
  } catch (e) {
    alert('Failed to save prompt: ' + e.message);
  } finally {
    saveBtn.textContent = 'Save';
    saveBtn.disabled = textarea.value === promptOriginals[id];
  }
}

/* ── Log Table ───────────────────────────────────────────────── */
let expandedLogId = null;

function addLogRow(entry, isNew) {
  const tbody = document.getElementById('logTableBody');
  const empty = document.getElementById('emptyState');
  if (empty) empty.style.display = 'none';

  const logId = entry.log_id || '';
  const tr = document.createElement('tr');
  tr.className = 'clickable';
  if (isNew) tr.classList.add('new-row');
  if (entry.error) tr.classList.add('error-row');
  else if (entry.is_fallback) tr.classList.add('fallback-row');
  if (logId) {
    tr.dataset.logId = logId;
    tr.onclick = () => toggleLogDetail(logId, tr);
  }

  const domains = (entry.detected_domains || []).map(d =>
    `<span class="badge badge-domain">${escapeHtml(d)}</span>`
  ).join(' ');

  const qualityBadge = entry.quality_action
    ? (entry.quality_action === 'pass'
      ? `<span class="badge badge-pass">pass</span>`
      : `<span class="badge badge-error">${escapeHtml(entry.quality_action)}</span>`)
    : '-';

  const statusBadge = entry.error
    ? `<span class="badge badge-error">error</span>`
    : (entry.is_fallback
      ? `<span class="badge badge-confidence-med">fallback</span>`
      : `<span class="badge badge-pass">ok</span>`);

  const entryMode = entry.retrieval_mode || 'rag';
  const modeBadge = `<span class="badge badge-mode-${entryMode}">${entryMode}</span>`;

  tr.innerHTML = `
    <td>${formatTime(entry.timestamp)}</td>
    <td title="${escapeHtml(entry.query)}">${escapeHtml(entry.query.substring(0, 60))}${entry.query.length > 60 ? '...' : ''}</td>
    <td>${modeBadge}</td>
    <td>${escapeHtml(entry.language || '-')}</td>
    <td>${domains || '-'}</td>
    <td>${entry.docs_retrieved}</td>
    <td>${entry.docs_graded}</td>
    <td>${entry.citations_count}</td>
    <td>${confBadge(entry.confidence)}</td>
    <td>${qualityBadge}</td>
    <td>${formatDuration(entry.duration_ms)}</td>
    <td>${statusBadge}</td>
  `;

  // Prepend newest on top
  if (tbody.firstChild) {
    tbody.insertBefore(tr, tbody.firstChild);
  } else {
    tbody.appendChild(tr);
  }

  // Limit to 200 rows (count only clickable rows, not detail rows)
  const clickableRows = tbody.querySelectorAll('tr.clickable');
  if (clickableRows.length > 200) {
    const last = clickableRows[clickableRows.length - 1];
    const nextSib = last.nextElementSibling;
    if (nextSib && nextSib.classList.contains('detail-row')) nextSib.remove();
    last.remove();
  }
}

/* ── Expandable Detail ────────────────────────────────────────── */
async function toggleLogDetail(logId, tr) {
  // If already expanded, collapse
  const existing = document.getElementById('detail-' + logId);
  if (existing) {
    existing.remove();
    expandedLogId = null;
    return;
  }

  // Collapse any other expanded detail
  if (expandedLogId) {
    const prev = document.getElementById('detail-' + expandedLogId);
    if (prev) prev.remove();
  }
  expandedLogId = logId;

  // Insert loading row
  const detailTr = document.createElement('tr');
  detailTr.className = 'detail-row';
  detailTr.id = 'detail-' + logId;
  detailTr.innerHTML = `<td colspan="12"><div class="detail-loading">Loading full response...</div></td>`;
  tr.after(detailTr);

  // Fetch detail from API
  try {
    const res = await fetch(`${API}/admin/logs/${logId}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    renderLogDetail(detailTr, data);
  } catch (err) {
    detailTr.innerHTML = `<td colspan="12"><div class="detail-loading" style="color:var(--red)">Failed to load detail: ${escapeHtml(err.message)}</div></td>`;
  }
}

function renderLogDetail(detailTr, data) {
  const citations = data.citations || [];

  let citationsHtml = '';
  if (citations.length > 0) {
    citationsHtml = `
      <div>
        <div class="detail-section-title">Citations (${citations.length})</div>
        <div class="detail-citations-list">
          ${citations.map((c, i) => {
            const file = c.source_file_path || '';
            const page = c.page_number || 0;
            return `
              <div class="detail-cit-card">
                <div class="detail-cit-num">${i + 1}</div>
                <div class="detail-cit-body">
                  ${file ? `<div class="detail-cit-file">${escapeHtml(file)}</div>` : ''}
                  ${page ? `<div class="detail-cit-page">Page ${page}</div>` : ''}
                  ${c.document_title ? `<div class="detail-cit-title">${escapeHtml(c.document_title)}</div>` : ''}
                  ${c.section ? `<div class="detail-cit-page">${escapeHtml(c.section)}</div>` : ''}
                  ${c.relevant_text ? `<div class="detail-cit-text">${escapeHtml(c.relevant_text)}</div>` : ''}
                  ${c.source_url ? `<div class="detail-cit-page"><a href="${escapeHtml(c.source_url)}" target="_blank" style="color:var(--azure)">${escapeHtml(c.source_url)}</a></div>` : ''}
                </div>
              </div>`;
          }).join('')}
        </div>
      </div>`;
  } else {
    citationsHtml = `
      <div>
        <div class="detail-section-title">Citations</div>
        <div style="font-size:13px;color:var(--muted);padding:8px 0;">No citations</div>
      </div>`;
  }

  detailTr.innerHTML = `
    <td colspan="12">
      <div class="detail-inner">
        <div>
          <div class="detail-section-title">Full Query</div>
          <div class="detail-answer">${escapeHtml(data.query)}</div>
        </div>
        ${data.rewritten_query ? `
        <div>
          <div class="detail-section-title">Rewritten Query</div>
          <div class="detail-answer">${escapeHtml(data.rewritten_query)}</div>
        </div>` : ''}
        <div>
          <div class="detail-section-title">Answer</div>
          <div class="detail-answer">${escapeHtml(data.answer || '(empty)')}</div>
        </div>
        ${citationsHtml}
        <div>
          <div class="detail-section-title">Metadata</div>
          <div class="detail-meta-grid">
            <div class="detail-meta-item">
              <div class="detail-meta-label">Conversation ID</div>
              <div class="detail-meta-value">${escapeHtml(data.conversation_id || '-')}</div>
            </div>
            <div class="detail-meta-item">
              <div class="detail-meta-label">Language</div>
              <div class="detail-meta-value">${escapeHtml(data.language || '-')}</div>
            </div>
            <div class="detail-meta-item">
              <div class="detail-meta-label">Domains</div>
              <div class="detail-meta-value">${(data.detected_domains || []).join(', ') || '-'}</div>
            </div>
            <div class="detail-meta-item">
              <div class="detail-meta-label">Confidence</div>
              <div class="detail-meta-value">${((data.confidence || 0) * 100).toFixed(0)}%</div>
            </div>
            <div class="detail-meta-item">
              <div class="detail-meta-label">Duration</div>
              <div class="detail-meta-value">${formatDuration(data.duration_ms)}</div>
            </div>
            <div class="detail-meta-item">
              <div class="detail-meta-label">Retrieval Mode</div>
              <div class="detail-meta-value">${escapeHtml(data.retrieval_mode || 'rag')}</div>
            </div>
            <div class="detail-meta-item">
              <div class="detail-meta-label">Quality Action</div>
              <div class="detail-meta-value">${escapeHtml(data.quality_action || '-')}</div>
            </div>
            ${data.error ? `
            <div class="detail-meta-item" style="border-color:var(--red)">
              <div class="detail-meta-label">Error</div>
              <div class="detail-meta-value" style="color:var(--red)">${escapeHtml(data.error)}</div>
            </div>` : ''}
          </div>
        </div>
      </div>
    </td>
  `;
}

/* ── Load initial logs ───────────────────────────────────────── */
async function fetchInitialLogs() {
  try {
    const res = await fetch(`${API}/admin/logs?limit=50`);
    const logs = await res.json();
    // logs are oldest-first; render them newest-first
    for (const entry of logs) {
      addLogRow(entry, false);
    }
  } catch (e) {
    // ok
  }
}

/* ── SSE Live Stream ─────────────────────────────────────────── */
function connectSSE() {
  const indicator = document.getElementById('liveIndicator');
  const liveText = document.getElementById('liveText');
  const liveDot = indicator.querySelector('.live-dot');

  const evtSource = new EventSource(`${API}/admin/logs/stream`);

  evtSource.addEventListener('query', (e) => {
    try {
      const entry = JSON.parse(e.data);
      addLogRow(entry, true);
      // Refresh stats on each new query
      fetchQueryStats();
    } catch (err) { /* ignore parse errors */ }
  });

  evtSource.addEventListener('ping', () => { /* keepalive */ });

  evtSource.onopen = () => {
    liveText.textContent = 'Live';
    liveDot.style.background = 'var(--green)';
  };

  evtSource.onerror = () => {
    liveText.textContent = 'Reconnecting...';
    liveDot.style.background = 'var(--amber)';
    evtSource.close();
    // Retry with backoff
    clearTimeout(sseRetryTimeout);
    sseRetryTimeout = setTimeout(connectSSE, 3000);
  };
}

/* ── Controls ────────────────────────────────────────────────── */
function toggleAutoscroll() {
  autoscroll = !autoscroll;
  document.getElementById('btnAutoscroll').classList.toggle('active', autoscroll);
}

function clearLogs() {
  document.getElementById('logTableBody').innerHTML = '';
  document.getElementById('emptyState').style.display = 'block';
}

/* ── LLM Traces ──────────────────────────────────────────────── */
let tracesCache = [];
let expandedTraceId = null;

async function fetchTraces() {
  try {
    const res = await fetch(`${API}/admin/traces?limit=50`);
    tracesCache = await res.json();
    renderTraces();
  } catch (e) {
    document.getElementById('tracesTableBody').innerHTML = '';
    document.getElementById('tracesEmptyState').style.display = 'block';
    document.getElementById('tracesEmptyState').textContent = 'Failed to load traces.';
  }
}

function renderTraces() {
  const tbody = document.getElementById('tracesTableBody');
  const empty = document.getElementById('tracesEmptyState');

  if (!tracesCache.length) {
    tbody.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  tbody.innerHTML = tracesCache.map(t => {
    const cfg = t.config || {};
    const mode = cfg.retrieval_mode || '-';
    const llm = cfg.inference_llm || '-';
    const modeBadge = `<span class="badge badge-mode-${mode}">${escapeHtml(mode)}</span>`;
    return `<tr onclick="toggleTraceDetail('${escapeHtml(t.trace_id)}')" data-trace-id="${escapeHtml(t.trace_id)}">
      <td>${t.timestamp ? formatTime(t.timestamp) : '-'}</td>
      <td title="${escapeHtml(t.query)}">${escapeHtml((t.query || '').substring(0, 60))}${(t.query || '').length > 60 ? '...' : ''}</td>
      <td>${modeBadge}</td>
      <td>${escapeHtml(llm)}</td>
      <td><span class="badge badge-domain">${t.llm_calls_count || 0}</span></td>
      <td>${t.duration_ms ? formatDuration(t.duration_ms) : '-'}</td>
    </tr>`;
  }).join('');
}

async function toggleTraceDetail(traceId) {
  const existing = document.getElementById('trace-detail-' + traceId);
  if (existing) {
    existing.remove();
    expandedTraceId = null;
    return;
  }

  // Collapse any previously expanded
  if (expandedTraceId) {
    const prev = document.getElementById('trace-detail-' + expandedTraceId);
    if (prev) prev.remove();
  }
  expandedTraceId = traceId;

  // Find the row and insert detail after it
  const row = document.querySelector(`tr[data-trace-id="${traceId}"]`);
  if (!row) return;

  const detailTr = document.createElement('tr');
  detailTr.className = 'trace-detail-row';
  detailTr.id = 'trace-detail-' + traceId;
  detailTr.innerHTML = `<td colspan="6"><div class="detail-loading">Loading trace...</div></td>`;
  row.after(detailTr);

  try {
    const res = await fetch(`${API}/admin/traces/${traceId}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    renderTraceDetail(detailTr, data);
  } catch (err) {
    detailTr.innerHTML = `<td colspan="6"><div class="detail-loading" style="color:var(--red)">Failed to load trace: ${escapeHtml(err.message)}</div></td>`;
  }
}

function renderTraceDetail(detailTr, data) {
  const config = data.config || {};
  const calls = data.llm_calls || [];
  const result = data.result || {};

  // Config tags
  const configHtml = Object.entries(config).map(([k, v]) =>
    `<div class="trace-config-tag"><span class="cfg-key">${escapeHtml(k)}:</span><span class="cfg-val">${escapeHtml(String(v))}</span></div>`
  ).join('');

  // Result summary
  const resultHtml = `
    <div class="trace-result-grid">
      <div class="trace-result-item">
        <div class="trace-result-label">Domains</div>
        <div class="trace-result-value">${(result.domains || []).join(', ') || '-'}</div>
      </div>
      <div class="trace-result-item">
        <div class="trace-result-label">Confidence</div>
        <div class="trace-result-value">${result.confidence ? (result.confidence * 100).toFixed(0) + '%' : '-'}</div>
      </div>
      <div class="trace-result-item">
        <div class="trace-result-label">Citations</div>
        <div class="trace-result-value">${result.citations_count ?? '-'}</div>
      </div>
      <div class="trace-result-item">
        <div class="trace-result-label">Total Duration</div>
        <div class="trace-result-value">${result.duration_ms ? formatDuration(result.duration_ms) : '-'}</div>
      </div>
      <div class="trace-result-item">
        <div class="trace-result-label">LLM Calls</div>
        <div class="trace-result-value">${calls.length}</div>
      </div>
    </div>`;

  // LLM calls timeline
  let callsHtml = '';
  if (calls.length > 0) {
    callsHtml = `<div class="trace-calls-timeline">${calls.map((c, i) => {
      const callId = `trace-call-${data.trace_id}-${i}`;
      return `<div class="trace-call-card">
        <div class="trace-call-index">${i + 1}</div>
        <div class="trace-call-body">
          <div class="trace-call-header">
            <span class="trace-call-node">${escapeHtml(c.node || 'unknown')}</span>
            <div class="trace-call-meta">
              <span>temp: ${c.temperature ?? '-'}</span>
              <span>max_tokens: ${c.max_tokens ?? '-'}</span>
              <span>duration: ${c.duration_ms ? formatDuration(c.duration_ms) : '-'}</span>
            </div>
            <button class="trace-call-toggle" onclick="event.stopPropagation(); toggleTraceCallContent('${callId}')">Show prompt/response</button>
          </div>
          <div id="${callId}" style="display:none;">
            ${c.system_prompt ? `<div><div class="trace-call-label">System Prompt</div><div class="trace-call-prompt-box">${escapeHtml(c.system_prompt)}</div></div>` : ''}
            <div><div class="trace-call-label">Prompt</div><div class="trace-call-prompt-box">${escapeHtml(c.prompt)}</div></div>
            <div><div class="trace-call-label">Response</div><div class="trace-call-response-box">${escapeHtml(c.response)}</div></div>
          </div>
        </div>
      </div>`;
    }).join('')}</div>`;
  } else {
    callsHtml = '<div style="font-size:13px;color:var(--muted);padding:8px 0;">No LLM calls recorded in this trace.</div>';
  }

  // Reasoning trace
  const reasoning = data.reasoning_trace || [];
  let reasoningHtml = '';
  if (reasoning.length > 0) {
    reasoningHtml = `
      <div>
        <div class="detail-section-title">Reasoning Trace</div>
        <div style="font-size:12px;color:var(--muted);line-height:1.6;">${reasoning.map(r => escapeHtml(r)).join('<br>')}</div>
      </div>`;
  }

  detailTr.innerHTML = `
    <td colspan="6">
      <div class="trace-detail-inner">
        <div>
          <div class="detail-section-title">Configuration Snapshot</div>
          <div class="trace-config-grid">${configHtml}</div>
        </div>
        <div>
          <div class="detail-section-title">Result Summary</div>
          ${resultHtml}
        </div>
        <div>
          <div class="detail-section-title">LLM Calls Timeline (${calls.length})</div>
          ${callsHtml}
        </div>
        ${reasoningHtml}
      </div>
    </td>`;
}

function toggleTraceCallContent(callId) {
  const el = document.getElementById(callId);
  if (!el) return;
  const btn = el.previousElementSibling.querySelector('.trace-call-toggle');
  if (el.style.display === 'none') {
    el.style.display = 'flex';
    el.style.flexDirection = 'column';
    el.style.gap = '8px';
    if (btn) btn.textContent = 'Hide prompt/response';
  } else {
    el.style.display = 'none';
    if (btn) btn.textContent = 'Show prompt/response';
  }
}

/* ── Init ────────────────────────────────────────────────────── */
(async function init() {
  // Initial data fetch (parallel)
  await Promise.all([fetchStatus(), fetchDocStats(), fetchQueryStats(), fetchInitialLogs(), fetchInferenceLLM(), fetchRetrievalMode(), fetchPrompts(), fetchGraphTopology(), fetchTraces()]);
  // Start SSE
  connectSSE();
  // Periodic refresh for status & docs (every 15s)
  setInterval(fetchStatus, 15000);
  setInterval(fetchDocStats, 60000);
  setInterval(fetchQueryStats, 15000);
})();
</script>
</body>
</html>
