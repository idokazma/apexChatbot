<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>×”×¨××œ ×‘×™×˜×•×— | ×¢×•×–×¨ ×“×™×’×™×˜×œ×™</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

:root {
  --navy: #003B7E;
  --navy-deep: #00254F;
  --navy-light: #1A5BA0;
  --azure: #4A90D9;
  --ice: #E8F0FE;
  --ice-light: #F4F8FF;
  --gold: #C6952B;
  --gold-light: #F5ECD7;
  --emerald: #2D8A56;
  --coral: #D94F4F;
  --slate: #4A5568;
  --slate-light: #94A3B8;
  --cloud: #F1F5F9;
  --white: #FFFFFF;
  --shadow-sm: 0 1px 3px rgba(0,27,63,0.06);
  --shadow-md: 0 4px 16px rgba(0,27,63,0.08);
  --shadow-lg: 0 8px 32px rgba(0,27,63,0.12);
  --shadow-xl: 0 16px 48px rgba(0,27,63,0.16);
  --radius: 16px;
  --radius-sm: 10px;
  --radius-xs: 6px;
  --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
}

html { height: 100%; }

body {
  font-family: 'Heebo', sans-serif;
  background: var(--ice-light);
  color: var(--navy-deep);
  height: 100%;
  overflow: hidden;
  -webkit-font-smoothing: antialiased;
}

/* â”€â”€ Background Pattern â”€â”€ */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    radial-gradient(ellipse 80% 60% at 20% 10%, rgba(0,59,126,0.04) 0%, transparent 70%),
    radial-gradient(ellipse 60% 50% at 85% 90%, rgba(74,144,217,0.05) 0%, transparent 70%);
  pointer-events: none;
  z-index: 0;
}

/* â”€â”€ App Shell â”€â”€ */
.app {
  display: flex;
  flex-direction: column;
  height: 100vh;
  max-width: 900px;
  margin: 0 auto;
  position: relative;
  z-index: 1;
}

/* â”€â”€ Header â”€â”€ */
.header {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 18px 24px;
  background: var(--white);
  border-bottom: 1px solid rgba(0,59,126,0.08);
  box-shadow: var(--shadow-sm);
  flex-shrink: 0;
}

.header-logo {
  width: 44px;
  height: 44px;
  background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 8px rgba(0,59,126,0.2);
  flex-shrink: 0;
}

.header-logo svg { width: 24px; height: 24px; }

.header-text { flex: 1; }

.header-title {
  font-size: 18px;
  font-weight: 700;
  color: var(--navy-deep);
  letter-spacing: -0.3px;
}

.header-subtitle {
  font-size: 12.5px;
  color: var(--slate-light);
  font-weight: 400;
  margin-top: 1px;
}

.header-status {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: var(--emerald);
  font-weight: 500;
}

.status-dot {
  width: 7px;
  height: 7px;
  background: var(--emerald);
  border-radius: 50%;
  animation: pulse-dot 2s ease-in-out infinite;
}

@keyframes pulse-dot {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.6; transform: scale(0.85); }
}

/* â”€â”€ Messages Area â”€â”€ */
.messages {
  flex: 1;
  overflow-y: auto;
  padding: 24px 20px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  scroll-behavior: smooth;
}

.messages::-webkit-scrollbar { width: 5px; }
.messages::-webkit-scrollbar-track { background: transparent; }
.messages::-webkit-scrollbar-thumb {
  background: rgba(0,59,126,0.12);
  border-radius: 10px;
}
.messages::-webkit-scrollbar-thumb:hover { background: rgba(0,59,126,0.22); }

/* â”€â”€ Welcome â”€â”€ */
.welcome {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  text-align: center;
  animation: welcome-in 0.7s ease-out;
}

@keyframes welcome-in {
  from { opacity: 0; transform: translateY(16px); }
  to { opacity: 1; transform: translateY(0); }
}

.welcome-icon {
  width: 72px;
  height: 72px;
  background: linear-gradient(135deg, var(--navy) 0%, var(--azure) 100%);
  border-radius: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 20px;
  box-shadow: 0 8px 24px rgba(0,59,126,0.18);
}

.welcome-icon svg { width: 36px; height: 36px; }

.welcome h2 {
  font-size: 22px;
  font-weight: 700;
  color: var(--navy-deep);
  margin-bottom: 8px;
}

.welcome p {
  font-size: 14.5px;
  color: var(--slate);
  line-height: 1.6;
  max-width: 380px;
}

.welcome-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
  margin-top: 24px;
}

.welcome-chip {
  padding: 9px 16px;
  background: var(--white);
  border: 1.5px solid rgba(0,59,126,0.1);
  border-radius: 24px;
  font-size: 13px;
  color: var(--navy);
  cursor: pointer;
  transition: var(--transition);
  font-family: inherit;
  font-weight: 500;
}

.welcome-chip:hover {
  background: var(--ice);
  border-color: var(--azure);
  transform: translateY(-1px);
  box-shadow: var(--shadow-sm);
}

/* â”€â”€ Message Bubbles â”€â”€ */
.msg-row {
  display: flex;
  gap: 10px;
  max-width: 82%;
  animation: msg-in 0.35s ease-out;
}

@keyframes msg-in {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.msg-row.user {
  align-self: flex-start;
  flex-direction: row;
}

.msg-row.bot {
  align-self: flex-end;
  flex-direction: row-reverse;
}

.msg-avatar {
  width: 34px;
  height: 34px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  margin-top: 2px;
}

.msg-row.user .msg-avatar {
  background: var(--cloud);
}

.msg-row.bot .msg-avatar {
  background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
  box-shadow: 0 2px 6px rgba(0,59,126,0.15);
}

.msg-avatar svg { width: 17px; height: 17px; }

.msg-content { flex: 1; min-width: 0; }

.msg-bubble {
  padding: 13px 17px;
  border-radius: var(--radius);
  font-size: 14.5px;
  line-height: 1.65;
  word-wrap: break-word;
}

.msg-row.user .msg-bubble {
  background: var(--white);
  color: var(--navy-deep);
  border: 1px solid rgba(0,59,126,0.07);
  border-bottom-right-radius: var(--radius);
  border-bottom-left-radius: 4px;
  box-shadow: var(--shadow-sm);
}

.msg-row.bot .msg-bubble {
  background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
  color: var(--white);
  border-bottom-left-radius: var(--radius);
  border-bottom-right-radius: 4px;
  box-shadow: var(--shadow-md);
}

.msg-row.bot .msg-bubble a {
  color: var(--gold-light);
  text-decoration: underline;
  text-underline-offset: 2px;
}

/* â”€â”€ Message Meta â”€â”€ */
.msg-meta {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 7px;
  flex-wrap: wrap;
}

.msg-row.bot .msg-meta { justify-content: flex-end; }

.domain-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 10px;
  background: var(--ice);
  border: 1px solid rgba(0,59,126,0.1);
  border-radius: 20px;
  font-size: 11.5px;
  font-weight: 600;
  color: var(--navy);
}

.domain-badge .domain-icon { font-size: 13px; }

.confidence-tag {
  font-size: 11px;
  font-weight: 500;
  padding: 2px 8px;
  border-radius: 12px;
}

.confidence-tag.high { background: #E6F5EC; color: var(--emerald); }
.confidence-tag.medium { background: var(--gold-light); color: #8B6914; }
.confidence-tag.low { background: #FDE8E8; color: var(--coral); }

/* â”€â”€ Citations â”€â”€ */
.citations-toggle {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  margin-top: 6px;
  padding: 4px 10px;
  font-size: 11.5px;
  font-weight: 500;
  color: var(--azure);
  background: rgba(74,144,217,0.08);
  border: none;
  border-radius: 14px;
  cursor: pointer;
  font-family: inherit;
  transition: var(--transition);
}

.citations-toggle:hover { background: rgba(74,144,217,0.14); }

.citations-toggle svg {
  width: 12px;
  height: 12px;
  transition: transform 0.25s ease;
}

.citations-toggle.open svg { transform: rotate(180deg); }

.citations-panel {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.35s ease, margin 0.35s ease;
}

.citations-panel.open {
  max-height: 600px;
  margin-top: 8px;
}

.citation-card {
  display: flex;
  gap: 10px;
  padding: 10px 13px;
  background: var(--white);
  border: 1px solid rgba(0,59,126,0.08);
  border-radius: var(--radius-sm);
  margin-bottom: 6px;
  transition: var(--transition);
}

.citation-card:hover {
  border-color: var(--azure);
  box-shadow: var(--shadow-sm);
}

.citation-num {
  width: 22px;
  height: 22px;
  background: var(--ice);
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 700;
  color: var(--navy);
  flex-shrink: 0;
  margin-top: 1px;
}

.citation-body { flex: 1; min-width: 0; }

.citation-title {
  font-size: 12.5px;
  font-weight: 600;
  color: var(--navy-deep);
  margin-bottom: 2px;
}

.citation-section {
  font-size: 11.5px;
  color: var(--slate-light);
  margin-bottom: 4px;
}

.citation-text {
  font-size: 12px;
  color: var(--slate);
  line-height: 1.5;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.citation-link {
  font-size: 11px;
  color: var(--azure);
  text-decoration: none;
  font-weight: 500;
  display: inline-flex;
  align-items: center;
  gap: 3px;
  margin-top: 4px;
}

.citation-link:hover { text-decoration: underline; }

/* â”€â”€ Loading â”€â”€ */
.msg-row.loading .msg-bubble {
  display: flex;
  align-items: center;
  gap: 10px;
  min-width: 90px;
}

.typing-dots {
  display: flex;
  gap: 4px;
  align-items: center;
}

.typing-dots span {
  width: 7px;
  height: 7px;
  background: rgba(255,255,255,0.5);
  border-radius: 50%;
  animation: typing 1.2s ease-in-out infinite;
}

.typing-dots span:nth-child(2) { animation-delay: 0.15s; }
.typing-dots span:nth-child(3) { animation-delay: 0.3s; }

@keyframes typing {
  0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
  30% { transform: translateY(-6px); opacity: 1; }
}

/* â”€â”€ Input Area â”€â”€ */
.input-area {
  padding: 16px 20px 20px;
  background: var(--white);
  border-top: 1px solid rgba(0,59,126,0.06);
  flex-shrink: 0;
}

.input-wrap {
  display: flex;
  align-items: flex-end;
  gap: 10px;
  background: var(--cloud);
  border: 2px solid transparent;
  border-radius: 18px;
  padding: 6px 6px 6px 16px;
  transition: var(--transition);
}

.input-wrap:focus-within {
  border-color: var(--azure);
  background: var(--white);
  box-shadow: 0 0 0 3px rgba(74,144,217,0.1);
}

.input-wrap textarea {
  flex: 1;
  border: none;
  outline: none;
  background: none;
  font-family: inherit;
  font-size: 14.5px;
  color: var(--navy-deep);
  resize: none;
  padding: 8px 0;
  line-height: 1.5;
  max-height: 120px;
  direction: rtl;
}

.input-wrap textarea::placeholder { color: var(--slate-light); }

.send-btn {
  width: 42px;
  height: 42px;
  background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
  border: none;
  border-radius: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
  flex-shrink: 0;
}

.send-btn:hover:not(:disabled) {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(0,59,126,0.25);
}

.send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

.send-btn svg { width: 18px; height: 18px; transform: rotate(180deg); }

.input-hint {
  text-align: center;
  font-size: 11px;
  color: var(--slate-light);
  margin-top: 8px;
}

/* â”€â”€ Mobile â”€â”€ */
@media (max-width: 640px) {
  .app { max-width: 100%; }
  .header { padding: 14px 16px; }
  .messages { padding: 16px 12px; }
  .msg-row { max-width: 90%; }
  .input-area { padding: 12px 12px 16px; }
  .welcome { padding: 40px 16px; }
  .welcome-chips { gap: 6px; }
  .welcome-chip { font-size: 12px; padding: 7px 12px; }
}
</style>
</head>
<body>

<div class="app">
  <!-- Header -->
  <header class="header">
    <div class="header-logo">
      <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
      </svg>
    </div>
    <div class="header-text">
      <div class="header-title">×”×¨××œ ×‘×™×˜×•×— â€” ×¢×•×–×¨ ×“×™×’×™×˜×œ×™</div>
      <div class="header-subtitle">×©×™×¨×•×ª ×œ×§×•×—×•×ª ×—×›× ××‘×•×¡×¡ ×‘×™× ×” ××œ××›×•×ª×™×ª</div>
    </div>
    <div class="header-status">
      <span class="status-dot"></span>
      ××—×•×‘×¨
    </div>
  </header>

  <!-- Messages -->
  <div class="messages" id="messages">
    <div class="welcome" id="welcome">
      <div class="welcome-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
      </div>
      <h2>×©×œ×•×! ××™×š ××•×›×œ ×œ×¢×–×•×¨?</h2>
      <p>×× ×™ ×”×¢×•×–×¨ ×”×“×™×’×™×˜×œ×™ ×©×œ ×”×¨××œ ×‘×™×˜×•×—. ××©××— ×œ×¢× ×•×ª ×¢×œ ×©××œ×•×ª ×‘× ×•×©××™ ×‘×™×˜×•×— ×¨×›×‘, ×—×™×™×, × ×¡×™×¢×•×ª, ×‘×¨×™××•×ª, ×©×™× ×™×™×, ××©×›× ×ª×, ×¢×¡×§×™× ×•×“×™×¨×”.</p>
      <div class="welcome-chips">
        <button class="welcome-chip" onclick="sendSuggestion('××” ××›×¡×” ×‘×™×˜×•×— × ×¡×™×¢×•×ª ×œ×—×•×´×œ?')">ğŸŒ ×‘×™×˜×•×— × ×¡×™×¢×•×ª</button>
        <button class="welcome-chip" onclick="sendSuggestion('××” ×”×›×™×¡×•×™×™× ×‘×‘×™×˜×•×— ×¨×›×‘ ××§×™×£?')">ğŸš— ×‘×™×˜×•×— ×¨×›×‘</button>
        <button class="welcome-chip" onclick="sendSuggestion('××” ×›×•×œ×œ ×‘×™×˜×•×— ×“×™×¨×”?')">ğŸ  ×‘×™×˜×•×— ×“×™×¨×”</button>
        <button class="welcome-chip" onclick="sendSuggestion('××” ×”×–×›×•×™×•×ª ×©×œ×™ ×‘×‘×™×˜×•×— ×‘×¨×™××•×ª?')">ğŸ’Š ×‘×™×˜×•×— ×‘×¨×™××•×ª</button>
      </div>
    </div>
  </div>

  <!-- Input -->
  <div class="input-area">
    <div class="input-wrap">
      <textarea id="input" rows="1" placeholder="×©××œ×• ××•×ª×™ ×¢×œ ×‘×™×˜×•×—..." onkeydown="handleKey(event)" oninput="autoGrow(this)"></textarea>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
        </svg>
      </button>
    </div>
    <div class="input-hint">×”×ª×©×•×‘×•×ª ××‘×•×¡×¡×•×ª ×¢×œ ××¡××›×™ ×”×¨××œ ×‘×™×˜×•×— ×”×¨×©××™×™×</div>
  </div>
</div>

<script>
const API_URL = window.location.origin;
let conversationId = null;
let isLoading = false;

const DOMAIN_MAP = {
  car: { label: '×¨×›×‘', icon: 'ğŸš—' },
  life: { label: '×—×™×™×', icon: 'ğŸ›¡ï¸' },
  travel: { label: '× ×¡×™×¢×•×ª', icon: 'âœˆï¸' },
  health: { label: '×‘×¨×™××•×ª', icon: 'ğŸ’Š' },
  dental: { label: '×©×™× ×™×™×', icon: 'ğŸ¦·' },
  mortgage: { label: '××©×›× ×ª×', icon: 'ğŸ¦' },
  business: { label: '×¢×¡×§×™×', icon: 'ğŸ’¼' },
  apartment: { label: '×“×™×¨×”', icon: 'ğŸ ' },
};

const input = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');
const messagesEl = document.getElementById('messages');
const welcomeEl = document.getElementById('welcome');

input.addEventListener('input', () => {
  sendBtn.disabled = !input.value.trim() || isLoading;
});

function autoGrow(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function sendSuggestion(text) {
  input.value = text;
  sendBtn.disabled = false;
  sendMessage();
}

function scrollToBottom() {
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function addUserMessage(text) {
  if (welcomeEl) welcomeEl.remove();

  const row = document.createElement('div');
  row.className = 'msg-row user';
  row.innerHTML = `
    <div class="msg-avatar">
      <svg viewBox="0 0 24 24" fill="none" stroke="#94A3B8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
      </svg>
    </div>
    <div class="msg-content">
      <div class="msg-bubble">${escapeHtml(text)}</div>
    </div>
  `;
  messagesEl.appendChild(row);
  scrollToBottom();
}

function addLoadingMessage() {
  const row = document.createElement('div');
  row.className = 'msg-row bot loading';
  row.id = 'loading-msg';
  row.innerHTML = `
    <div class="msg-avatar">
      <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
      </svg>
    </div>
    <div class="msg-content">
      <div class="msg-bubble">
        <div class="typing-dots"><span></span><span></span><span></span></div>
      </div>
    </div>
  `;
  messagesEl.appendChild(row);
  scrollToBottom();
}

function removeLoadingMessage() {
  const el = document.getElementById('loading-msg');
  if (el) el.remove();
}

function addBotMessage(data) {
  removeLoadingMessage();

  const { answer, citations, domain, confidence } = data;
  const domainInfo = domain && DOMAIN_MAP[domain];
  const confLevel = confidence >= 0.7 ? 'high' : confidence >= 0.4 ? 'medium' : 'low';
  const confLabel = confLevel === 'high' ? '×‘×™×˜×—×•×Ÿ ×’×‘×•×”' : confLevel === 'medium' ? '×‘×™×˜×—×•×Ÿ ×‘×™× ×•× ×™' : '×‘×™×˜×—×•×Ÿ × ××•×š';

  const citationId = 'cit-' + Date.now();
  let metaHtml = '<div class="msg-meta">';
  if (domainInfo) {
    metaHtml += `<span class="domain-badge"><span class="domain-icon">${domainInfo.icon}</span>${domainInfo.label}</span>`;
  }
  metaHtml += `<span class="confidence-tag ${confLevel}">${confLabel}</span>`;
  metaHtml += '</div>';

  let citationsHtml = '';
  if (citations && citations.length > 0) {
    citationsHtml = `
      <button class="citations-toggle" onclick="toggleCitations('${citationId}', this)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="6 9 12 15 18 9"/>
        </svg>
        ${citations.length} ××§×•×¨×•×ª
      </button>
      <div class="citations-panel" id="${citationId}">
        ${citations.map((c, i) => `
          <div class="citation-card">
            <div class="citation-num">${i + 1}</div>
            <div class="citation-body">
              <div class="citation-title">${escapeHtml(c.document_title || '××¡××š')}</div>
              ${c.section ? `<div class="citation-section">${escapeHtml(c.section)}</div>` : ''}
              ${c.relevant_text ? `<div class="citation-text">${escapeHtml(c.relevant_text)}</div>` : ''}
              ${c.source_url ? `<a class="citation-link" href="${escapeHtml(c.source_url)}" target="_blank" rel="noopener">×¤×ª×— ××§×•×¨ â†</a>` : ''}
            </div>
          </div>
        `).join('')}
      </div>
    `;
  }

  const row = document.createElement('div');
  row.className = 'msg-row bot';
  row.innerHTML = `
    <div class="msg-avatar">
      <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
      </svg>
    </div>
    <div class="msg-content">
      <div class="msg-bubble">${formatAnswer(answer)}</div>
      ${metaHtml}
      ${citationsHtml}
    </div>
  `;
  messagesEl.appendChild(row);
  scrollToBottom();
}

function toggleCitations(id, btn) {
  const panel = document.getElementById(id);
  panel.classList.toggle('open');
  btn.classList.toggle('open');
}

function formatAnswer(text) {
  // Basic markdown-like formatting
  let html = escapeHtml(text);
  // Bold
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  // Line breaks
  html = html.replace(/\n/g, '<br>');
  // Bullet points
  html = html.replace(/^- (.+)/gm, 'â€¢ $1');
  return html;
}

function escapeHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

async function sendMessage() {
  const text = input.value.trim();
  if (!text || isLoading) return;

  isLoading = true;
  input.value = '';
  input.style.height = 'auto';
  sendBtn.disabled = true;

  addUserMessage(text);
  addLoadingMessage();

  try {
    const res = await fetch(`${API_URL}/chat`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: text,
        conversation_id: conversationId,
      }),
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const data = await res.json();
    conversationId = data.conversation_id;
    addBotMessage(data);
  } catch (err) {
    removeLoadingMessage();
    addBotMessage({
      answer: '××¦×˜×¢×¨, ××™×¨×¢×” ×©×’×™××” ×‘×¢×™×‘×•×“ ×”×‘×§×©×”. ×× × × ×¡×• ×©×•×‘.',
      citations: [],
      domain: null,
      confidence: 0,
    });
    console.error('Chat error:', err);
  } finally {
    isLoading = false;
    sendBtn.disabled = !input.value.trim();
    input.focus();
  }
}
</script>
</body>
</html>
