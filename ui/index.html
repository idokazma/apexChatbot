<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>×”×¨××œ ×‘×™×˜×•×— | ×¢×•×–×¨ ×“×™×’×™×˜×œ×™</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

:root {
  --navy: #003B7E;
  --navy-deep: #00254F;
  --navy-light: #1A5BA0;
  --azure: #4A90D9;
  --ice: #E8F0FE;
  --ice-light: #F4F8FF;
  --gold: #C6952B;
  --gold-light: #F5ECD7;
  --emerald: #2D8A56;
  --coral: #D94F4F;
  --slate: #4A5568;
  --slate-light: #94A3B8;
  --cloud: #F1F5F9;
  --white: #FFFFFF;
  --shadow-sm: 0 1px 3px rgba(0,27,63,0.06);
  --shadow-md: 0 4px 16px rgba(0,27,63,0.08);
  --shadow-lg: 0 8px 32px rgba(0,27,63,0.12);
  --shadow-xl: 0 16px 48px rgba(0,27,63,0.16);
  --radius: 16px;
  --radius-sm: 10px;
  --radius-xs: 6px;
  --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
}

html { height: 100%; }

body {
  font-family: 'Heebo', sans-serif;
  background: var(--ice-light);
  color: var(--navy-deep);
  height: 100%;
  overflow: hidden;
  -webkit-font-smoothing: antialiased;
}

/* â”€â”€ Background Pattern â”€â”€ */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    radial-gradient(ellipse 80% 60% at 20% 10%, rgba(0,59,126,0.04) 0%, transparent 70%),
    radial-gradient(ellipse 60% 50% at 85% 90%, rgba(74,144,217,0.05) 0%, transparent 70%);
  pointer-events: none;
  z-index: 0;
}

/* â”€â”€ App Shell â”€â”€ */
.app {
  display: flex;
  flex-direction: column;
  height: 100vh;
  max-width: 900px;
  margin: 0 auto;
  position: relative;
  z-index: 1;
}

/* â”€â”€ Header â”€â”€ */
.header {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 18px 24px;
  background: var(--white);
  border-bottom: 1px solid rgba(0,59,126,0.08);
  box-shadow: var(--shadow-sm);
  flex-shrink: 0;
}

.header-logo {
  width: 44px;
  height: 44px;
  background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 8px rgba(0,59,126,0.2);
  flex-shrink: 0;
}

.header-logo svg { width: 24px; height: 24px; }

.header-text { flex: 1; }

.header-title {
  font-size: 18px;
  font-weight: 700;
  color: var(--navy-deep);
  letter-spacing: -0.3px;
}

.header-subtitle {
  font-size: 12.5px;
  color: var(--slate-light);
  font-weight: 400;
  margin-top: 1px;
}

.header-status {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: var(--emerald);
  font-weight: 500;
}

.status-dot {
  width: 7px;
  height: 7px;
  background: var(--emerald);
  border-radius: 50%;
  animation: pulse-dot 2s ease-in-out infinite;
}

@keyframes pulse-dot {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.6; transform: scale(0.85); }
}

/* â”€â”€ Messages Area â”€â”€ */
.messages {
  flex: 1;
  overflow-y: auto;
  padding: 24px 20px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  scroll-behavior: smooth;
}

.messages::-webkit-scrollbar { width: 5px; }
.messages::-webkit-scrollbar-track { background: transparent; }
.messages::-webkit-scrollbar-thumb {
  background: rgba(0,59,126,0.12);
  border-radius: 10px;
}
.messages::-webkit-scrollbar-thumb:hover { background: rgba(0,59,126,0.22); }

/* â”€â”€ Welcome â”€â”€ */
.welcome {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  text-align: center;
  animation: welcome-in 0.7s ease-out;
}

@keyframes welcome-in {
  from { opacity: 0; transform: translateY(16px); }
  to { opacity: 1; transform: translateY(0); }
}

.welcome-icon {
  width: 72px;
  height: 72px;
  background: linear-gradient(135deg, var(--navy) 0%, var(--azure) 100%);
  border-radius: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 20px;
  box-shadow: 0 8px 24px rgba(0,59,126,0.18);
}

.welcome-icon svg { width: 36px; height: 36px; }

.welcome h2 {
  font-size: 22px;
  font-weight: 700;
  color: var(--navy-deep);
  margin-bottom: 8px;
}

.welcome p {
  font-size: 14.5px;
  color: var(--slate);
  line-height: 1.6;
  max-width: 380px;
}

.welcome-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
  margin-top: 24px;
}

.welcome-chip {
  padding: 9px 16px;
  background: var(--white);
  border: 1.5px solid rgba(0,59,126,0.1);
  border-radius: 24px;
  font-size: 13px;
  color: var(--navy);
  cursor: pointer;
  transition: var(--transition);
  font-family: inherit;
  font-weight: 500;
}

.welcome-chip:hover {
  background: var(--ice);
  border-color: var(--azure);
  transform: translateY(-1px);
  box-shadow: var(--shadow-sm);
}

.welcome-chip.selected {
  background: var(--navy);
  color: var(--white);
  border-color: var(--navy);
}

/* â”€â”€ Message Bubbles â”€â”€ */
.msg-row {
  display: flex;
  gap: 10px;
  max-width: 82%;
  animation: msg-in 0.35s ease-out;
}

@keyframes msg-in {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.msg-row.user {
  align-self: flex-start;
  flex-direction: row;
}

.msg-row.bot {
  align-self: flex-end;
  flex-direction: row-reverse;
}

.msg-avatar {
  width: 34px;
  height: 34px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  margin-top: 2px;
}

.msg-row.user .msg-avatar {
  background: var(--cloud);
}

.msg-row.bot .msg-avatar {
  background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
  box-shadow: 0 2px 6px rgba(0,59,126,0.15);
}

.msg-avatar svg { width: 17px; height: 17px; }

.msg-content { flex: 1; min-width: 0; }

.msg-bubble {
  padding: 13px 17px;
  border-radius: var(--radius);
  font-size: 14.5px;
  line-height: 1.65;
  word-wrap: break-word;
}

.msg-row.user .msg-bubble {
  background: var(--white);
  color: var(--navy-deep);
  border: 1px solid rgba(0,59,126,0.07);
  border-bottom-right-radius: var(--radius);
  border-bottom-left-radius: 4px;
  box-shadow: var(--shadow-sm);
}

.msg-row.bot .msg-bubble {
  background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
  color: var(--white);
  border-bottom-left-radius: var(--radius);
  border-bottom-right-radius: 4px;
  box-shadow: var(--shadow-md);
}

.msg-row.bot .msg-bubble a {
  color: var(--gold-light);
  text-decoration: underline;
  text-underline-offset: 2px;
}

/* â”€â”€ Message Meta â”€â”€ */
.msg-meta {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 7px;
  flex-wrap: wrap;
}

.msg-row.bot .msg-meta { justify-content: flex-end; }

.domain-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 10px;
  background: var(--ice);
  border: 1px solid rgba(0,59,126,0.1);
  border-radius: 20px;
  font-size: 11.5px;
  font-weight: 600;
  color: var(--navy);
}

.domain-badge .domain-icon { font-size: 13px; }

.confidence-tag {
  font-size: 11px;
  font-weight: 500;
  padding: 2px 8px;
  border-radius: 12px;
}

.confidence-tag.high { background: #E6F5EC; color: var(--emerald); }
.confidence-tag.medium { background: var(--gold-light); color: #8B6914; }
.confidence-tag.low { background: #FDE8E8; color: var(--coral); }

.mode-badge {
  font-size: 10px;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 12px;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}
.mode-badge.rag { background: #E0E7FF; color: #3730A3; }
.mode-badge.agentic { background: #FEF3C7; color: #92400E; }
.mode-badge.combined { background: #ECFDF5; color: #065F46; }

.nav-trace {
  margin-top: 6px;
  font-size: 11px;
  color: var(--slate-light);
  line-height: 1.5;
}
.nav-trace-toggle {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  margin-top: 6px;
  padding: 4px 10px;
  font-size: 11px;
  font-weight: 500;
  color: var(--slate);
  background: rgba(74,85,104,0.06);
  border: none;
  border-radius: 14px;
  cursor: pointer;
  font-family: inherit;
  transition: var(--transition);
}
.nav-trace-toggle:hover { background: rgba(74,85,104,0.12); }
.nav-trace-toggle svg { width: 12px; height: 12px; }
.nav-trace-toggle.open svg { transform: rotate(180deg); }
.nav-trace-panel {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
}
.nav-trace-panel.open { max-height: 300px; }
.nav-trace-step {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 3px 0;
  font-size: 11px;
  color: var(--slate);
}
.nav-trace-step .step-icon {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 9px;
  background: var(--ice);
  color: var(--navy);
  flex-shrink: 0;
}

/* â”€â”€ Mode Toggle â”€â”€ */
.mode-toggle {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 4px;
  background: var(--cloud);
  border-radius: 10px;
  flex-shrink: 0;
}

.mode-toggle-btn {
  padding: 5px 12px;
  font-size: 11.5px;
  font-weight: 600;
  font-family: inherit;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: var(--transition);
  color: var(--slate);
  background: transparent;
  white-space: nowrap;
}

.mode-toggle-btn.active {
  background: var(--white);
  color: var(--navy);
  box-shadow: var(--shadow-sm);
}

.mode-toggle-btn:hover:not(.active) {
  color: var(--navy);
}

/* â”€â”€ Regular Mode Source Card â”€â”€ */
.source-card {
  margin-top: 10px;
  padding: 10px 14px;
  background: rgba(255,255,255,0.12);
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  gap: 10px;
}

.source-card-icon {
  width: 30px;
  height: 30px;
  background: rgba(255,255,255,0.15);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.source-card-icon svg {
  width: 16px;
  height: 16px;
  stroke: rgba(255,255,255,0.8);
}

.source-card-body {
  flex: 1;
  min-width: 0;
}

.source-card-file {
  font-size: 12.5px;
  font-weight: 600;
  color: rgba(255,255,255,0.95);
  word-break: break-all;
  direction: ltr;
  text-align: right;
}

.source-card-page {
  font-size: 11.5px;
  color: rgba(255,255,255,0.65);
  margin-top: 2px;
}

.source-separator {
  margin-top: 6px;
  font-size: 11px;
  font-weight: 600;
  color: rgba(255,255,255,0.5);
  letter-spacing: 0.3px;
}

/* â”€â”€ Debug JSON Panel â”€â”€ */
.debug-toggle {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  margin-top: 6px;
  padding: 4px 10px;
  font-size: 11px;
  font-weight: 600;
  color: var(--slate);
  background: rgba(74,85,104,0.06);
  border: none;
  border-radius: 14px;
  cursor: pointer;
  font-family: inherit;
  transition: var(--transition);
  letter-spacing: 0.2px;
}

.debug-toggle:hover { background: rgba(74,85,104,0.12); }

.debug-toggle svg {
  width: 12px;
  height: 12px;
  transition: transform 0.25s ease;
}

.debug-toggle.open svg { transform: rotate(180deg); }

.debug-panel {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.35s ease, margin 0.35s ease;
}

.debug-panel.open {
  max-height: 2000px;
  margin-top: 8px;
}

.debug-json {
  background: #1E293B;
  color: #E2E8F0;
  padding: 12px 14px;
  border-radius: var(--radius-sm);
  font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
  font-size: 11px;
  line-height: 1.6;
  white-space: pre-wrap;
  word-break: break-all;
  max-height: 400px;
  overflow-y: auto;
  direction: ltr;
  text-align: left;
}

.debug-json::-webkit-scrollbar { width: 5px; }
.debug-json::-webkit-scrollbar-track { background: transparent; }
.debug-json::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 10px; }

/* â”€â”€ Citations â”€â”€ */
.citations-toggle {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  margin-top: 6px;
  padding: 4px 10px;
  font-size: 11.5px;
  font-weight: 500;
  color: var(--azure);
  background: rgba(74,144,217,0.08);
  border: none;
  border-radius: 14px;
  cursor: pointer;
  font-family: inherit;
  transition: var(--transition);
}

.citations-toggle:hover { background: rgba(74,144,217,0.14); }

.citations-toggle svg {
  width: 12px;
  height: 12px;
  transition: transform 0.25s ease;
}

.citations-toggle.open svg { transform: rotate(180deg); }

.citations-panel {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.35s ease, margin 0.35s ease;
}

.citations-panel.open {
  max-height: 600px;
  margin-top: 8px;
}

.citation-card {
  display: flex;
  gap: 10px;
  padding: 10px 13px;
  background: var(--white);
  border: 1px solid rgba(0,59,126,0.08);
  border-radius: var(--radius-sm);
  margin-bottom: 6px;
  transition: var(--transition);
}

.citation-card:hover {
  border-color: var(--azure);
  box-shadow: var(--shadow-sm);
}

.citation-num {
  width: 22px;
  height: 22px;
  background: var(--ice);
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 700;
  color: var(--navy);
  flex-shrink: 0;
  margin-top: 1px;
}

.citation-body { flex: 1; min-width: 0; }

.citation-title {
  font-size: 12.5px;
  font-weight: 600;
  color: var(--navy-deep);
  margin-bottom: 2px;
}

.citation-section {
  font-size: 11.5px;
  color: var(--slate-light);
  margin-bottom: 4px;
}

.citation-text {
  font-size: 12px;
  color: var(--slate);
  line-height: 1.5;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.citation-link {
  font-size: 11px;
  color: var(--azure);
  text-decoration: none;
  font-weight: 500;
  display: inline-flex;
  align-items: center;
  gap: 3px;
  margin-top: 4px;
}

.citation-link:hover { text-decoration: underline; }

/* â”€â”€ Loading â”€â”€ */
.msg-row.loading .msg-bubble {
  display: flex;
  align-items: center;
  gap: 10px;
  min-width: 90px;
}

.typing-dots {
  display: flex;
  gap: 4px;
  align-items: center;
}

.typing-dots span {
  width: 7px;
  height: 7px;
  background: rgba(255,255,255,0.5);
  border-radius: 50%;
  animation: typing 1.2s ease-in-out infinite;
}

.typing-dots span:nth-child(2) { animation-delay: 0.15s; }
.typing-dots span:nth-child(3) { animation-delay: 0.3s; }

@keyframes typing {
  0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
  30% { transform: translateY(-6px); opacity: 1; }
}

/* â”€â”€ Input Area â”€â”€ */
.input-area {
  padding: 16px 20px 20px;
  background: var(--white);
  border-top: 1px solid rgba(0,59,126,0.06);
  flex-shrink: 0;
}

.input-wrap {
  display: flex;
  align-items: flex-end;
  gap: 10px;
  background: var(--cloud);
  border: 2px solid transparent;
  border-radius: 18px;
  padding: 6px 6px 6px 16px;
  transition: var(--transition);
}

.input-wrap:focus-within {
  border-color: var(--azure);
  background: var(--white);
  box-shadow: 0 0 0 3px rgba(74,144,217,0.1);
}

.input-wrap textarea {
  flex: 1;
  border: none;
  outline: none;
  background: none;
  font-family: inherit;
  font-size: 14.5px;
  color: var(--navy-deep);
  resize: none;
  padding: 8px 0;
  line-height: 1.5;
  max-height: 120px;
  direction: rtl;
}

.input-wrap textarea::placeholder { color: var(--slate-light); }

.send-btn {
  width: 42px;
  height: 42px;
  background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
  border: none;
  border-radius: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
  flex-shrink: 0;
}

.send-btn:hover:not(:disabled) {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(0,59,126,0.25);
}

.send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

.send-btn svg { width: 18px; height: 18px; transform: rotate(180deg); }

.input-hint {
  text-align: center;
  font-size: 11px;
  color: var(--slate-light);
  margin-top: 8px;
}

.domain-tag-input {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  background: var(--navy);
  color: var(--white);
  border-radius: 14px;
  font-size: 12px;
  font-weight: 600;
  white-space: nowrap;
  flex-shrink: 0;
}

.domain-tag-x {
  cursor: pointer;
  font-size: 14px;
  font-weight: 400;
  opacity: 0.7;
  margin-right: 2px;
}

.domain-tag-x:hover { opacity: 1; }

/* â”€â”€ Mobile â”€â”€ */
@media (max-width: 640px) {
  .app { max-width: 100%; }
  .header { padding: 14px 16px; }
  .messages { padding: 16px 12px; }
  .msg-row { max-width: 90%; }
  .input-area { padding: 12px 12px 16px; }
  .welcome { padding: 40px 16px; }
  .welcome-chips { gap: 6px; }
  .welcome-chip { font-size: 12px; padding: 7px 12px; }
}
</style>
</head>
<body>

<div class="app">
  <!-- Header -->
  <header class="header">
    <div class="header-logo">
      <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
      </svg>
    </div>
    <div class="header-text">
      <div class="header-title">×”×¨××œ ×‘×™×˜×•×— â€” ×¢×•×–×¨ ×“×™×’×™×˜×œ×™</div>
      <div class="header-subtitle">×©×™×¨×•×ª ×œ×§×•×—×•×ª ×—×›× ××‘×•×¡×¡ ×‘×™× ×” ××œ××›×•×ª×™×ª</div>
    </div>
    <div class="mode-toggle">
      <button class="mode-toggle-btn active" id="modeRegular" onclick="setViewMode('regular')">×¨×’×™×œ</button>
      <button class="mode-toggle-btn" id="modeDebug" onclick="setViewMode('debug')">Debug</button>
    </div>
    <div class="header-status">
      <span class="status-dot"></span>
      ××—×•×‘×¨
    </div>
  </header>

  <!-- Messages -->
  <div class="messages" id="messages">
    <div class="welcome" id="welcome">
      <div class="welcome-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
      </div>
      <h2>×©×œ×•×! ××™×š ××•×›×œ ×œ×¢×–×•×¨?</h2>
      <p>×× ×™ ×”×¢×•×–×¨ ×”×“×™×’×™×˜×œ×™ ×©×œ ×”×¨××œ ×‘×™×˜×•×—. ××©××— ×œ×¢× ×•×ª ×¢×œ ×©××œ×•×ª ×‘× ×•×©××™ ×‘×™×˜×•×— ×¨×›×‘, ×—×™×™×, × ×¡×™×¢×•×ª, ×‘×¨×™××•×ª, ×©×™× ×™×™×, ××©×›× ×ª×, ×¢×¡×§×™× ×•×“×™×¨×”.</p>
      <div class="welcome-chips">
        <button class="welcome-chip" onclick="selectDomain('travel')">ğŸŒ ×‘×™×˜×•×— × ×¡×™×¢×•×ª</button>
        <button class="welcome-chip" onclick="selectDomain('car')">ğŸš— ×‘×™×˜×•×— ×¨×›×‘</button>
        <button class="welcome-chip" onclick="selectDomain('apartment')">ğŸ  ×‘×™×˜×•×— ×“×™×¨×”</button>
        <button class="welcome-chip" onclick="selectDomain('health')">ğŸ’Š ×‘×™×˜×•×— ×‘×¨×™××•×ª</button>
        <button class="welcome-chip" onclick="selectDomain('life')">ğŸ›¡ï¸ ×‘×™×˜×•×— ×—×™×™×</button>
        <button class="welcome-chip" onclick="selectDomain('dental')">ğŸ¦· ×‘×™×˜×•×— ×©×™× ×™×™×</button>
        <button class="welcome-chip" onclick="selectDomain('mortgage')">ğŸ¦ ×‘×™×˜×•×— ××©×›× ×ª×</button>
        <button class="welcome-chip" onclick="selectDomain('business')">ğŸ’¼ ×‘×™×˜×•×— ×¢×¡×§×™×</button>
      </div>
    </div>
  </div>

  <!-- Input -->
  <div class="input-area">
    <div class="input-wrap">
      <textarea id="input" rows="1" placeholder="×©××œ×• ××•×ª×™ ×¢×œ ×‘×™×˜×•×—..." onkeydown="handleKey(event)" oninput="autoGrow(this)"></textarea>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
        </svg>
      </button>
    </div>
    <div class="input-hint">×”×ª×©×•×‘×•×ª ××‘×•×¡×¡×•×ª ×¢×œ ××¡××›×™ ×”×¨××œ ×‘×™×˜×•×— ×”×¨×©××™×™×</div>
  </div>
</div>

<script>
const API_URL = window.location.origin;
let conversationId = null;
let isLoading = false;
let viewMode = 'regular'; // 'regular' or 'debug'
let selectedDomain = null; // domain hint from chip click
let patienceTimer = null; // 30s patience message timer
// Store raw API responses so we can re-render when toggling modes
const messageStore = [];

const DOMAIN_MAP = {
  car: { label: '×¨×›×‘', icon: 'ğŸš—' },
  life: { label: '×—×™×™×', icon: 'ğŸ›¡ï¸' },
  travel: { label: '× ×¡×™×¢×•×ª', icon: 'âœˆï¸' },
  health: { label: '×‘×¨×™××•×ª', icon: 'ğŸ’Š' },
  dental: { label: '×©×™× ×™×™×', icon: 'ğŸ¦·' },
  mortgage: { label: '××©×›× ×ª×', icon: 'ğŸ¦' },
  business: { label: '×¢×¡×§×™×', icon: 'ğŸ’¼' },
  apartment: { label: '×“×™×¨×”', icon: 'ğŸ ' },
};

const input = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');
const messagesEl = document.getElementById('messages');
const welcomeEl = document.getElementById('welcome');

input.addEventListener('input', () => {
  sendBtn.disabled = !input.value.trim() || isLoading;
});

/* â”€â”€ View Mode Toggle â”€â”€ */

function setViewMode(mode) {
  viewMode = mode;
  document.getElementById('modeRegular').classList.toggle('active', mode === 'regular');
  document.getElementById('modeDebug').classList.toggle('active', mode === 'debug');
  rerenderMessages();
}

function rerenderMessages() {
  // Clear all messages
  messagesEl.innerHTML = '';
  // If no messages yet, show welcome
  if (messageStore.length === 0) {
    messagesEl.innerHTML = `
      <div class="welcome" id="welcome">
        <div class="welcome-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
        </div>
        <h2>×©×œ×•×! ××™×š ××•×›×œ ×œ×¢×–×•×¨?</h2>
        <p>×× ×™ ×”×¢×•×–×¨ ×”×“×™×’×™×˜×œ×™ ×©×œ ×”×¨××œ ×‘×™×˜×•×—. ××©××— ×œ×¢× ×•×ª ×¢×œ ×©××œ×•×ª ×‘× ×•×©××™ ×‘×™×˜×•×— ×¨×›×‘, ×—×™×™×, × ×¡×™×¢×•×ª, ×‘×¨×™××•×ª, ×©×™× ×™×™×, ××©×›× ×ª×, ×¢×¡×§×™× ×•×“×™×¨×”.</p>
        <div class="welcome-chips">
          <button class="welcome-chip" onclick="selectDomain('travel')">ğŸŒ ×‘×™×˜×•×— × ×¡×™×¢×•×ª</button>
          <button class="welcome-chip" onclick="selectDomain('car')">ğŸš— ×‘×™×˜×•×— ×¨×›×‘</button>
          <button class="welcome-chip" onclick="selectDomain('apartment')">ğŸ  ×‘×™×˜×•×— ×“×™×¨×”</button>
          <button class="welcome-chip" onclick="selectDomain('health')">ğŸ’Š ×‘×™×˜×•×— ×‘×¨×™××•×ª</button>
          <button class="welcome-chip" onclick="selectDomain('life')">ğŸ›¡ï¸ ×‘×™×˜×•×— ×—×™×™×</button>
          <button class="welcome-chip" onclick="selectDomain('dental')">ğŸ¦· ×‘×™×˜×•×— ×©×™× ×™×™×</button>
          <button class="welcome-chip" onclick="selectDomain('mortgage')">ğŸ¦ ×‘×™×˜×•×— ××©×›× ×ª×</button>
          <button class="welcome-chip" onclick="selectDomain('business')">ğŸ’¼ ×‘×™×˜×•×— ×¢×¡×§×™×</button>
        </div>
      </div>`;
    return;
  }
  // Re-render all messages
  for (const entry of messageStore) {
    if (entry.type === 'user') {
      renderUserMessage(entry.text);
    } else {
      renderBotMessage(entry.data);
    }
  }
  scrollToBottom();
}

/* â”€â”€ Helpers â”€â”€ */

function autoGrow(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function sendSuggestion(text) {
  input.value = text;
  sendBtn.disabled = false;
  sendMessage();
}

function selectDomain(domain) {
  const domainInfo = DOMAIN_MAP[domain];
  if (!domainInfo) return;

  if (selectedDomain === domain) {
    // Deselect
    selectedDomain = null;
    updateDomainTag();
    return;
  }

  selectedDomain = domain;
  updateDomainTag();
  input.focus();
}

function updateDomainTag() {
  let tag = document.getElementById('domain-tag');
  if (selectedDomain) {
    const info = DOMAIN_MAP[selectedDomain];
    if (!tag) {
      tag = document.createElement('span');
      tag.id = 'domain-tag';
      tag.className = 'domain-tag-input';
      const wrap = document.querySelector('.input-wrap');
      wrap.insertBefore(tag, wrap.firstChild);
    }
    tag.innerHTML = `${info.icon} ${info.label} <span class="domain-tag-x" onclick="event.stopPropagation(); selectDomain('${selectedDomain}')">&times;</span>`;
  } else if (tag) {
    tag.remove();
  }
  // Update chip highlights
  document.querySelectorAll('.welcome-chip').forEach(chip => {
    const onclick = chip.getAttribute('onclick') || '';
    const match = onclick.match(/selectDomain\('(\w+)'\)/);
    if (match) {
      chip.classList.toggle('selected', match[1] === selectedDomain);
    }
  });
}

function scrollToBottom() {
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function formatAnswer(text) {
  let html = escapeHtml(text);
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  html = html.replace(/\n/g, '<br>');
  html = html.replace(/^- (.+)/gm, 'â€¢ $1');
  return html;
}

function escapeHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

/* â”€â”€ Render Functions â”€â”€ */

function renderUserMessage(text) {
  const row = document.createElement('div');
  row.className = 'msg-row user';
  row.innerHTML = `
    <div class="msg-avatar">
      <svg viewBox="0 0 24 24" fill="none" stroke="#94A3B8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
      </svg>
    </div>
    <div class="msg-content">
      <div class="msg-bubble">${escapeHtml(text)}</div>
    </div>
  `;
  messagesEl.appendChild(row);
}

function addUserMessage(text) {
  const w = document.getElementById('welcome');
  if (w) w.remove();
  messageStore.push({ type: 'user', text });
  renderUserMessage(text);
  scrollToBottom();
}

function addLoadingMessage() {
  const row = document.createElement('div');
  row.className = 'msg-row bot loading';
  row.id = 'loading-msg';
  row.innerHTML = `
    <div class="msg-avatar">
      <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
      </svg>
    </div>
    <div class="msg-content">
      <div class="msg-bubble">
        <div class="typing-dots"><span></span><span></span><span></span></div>
      </div>
    </div>
  `;
  messagesEl.appendChild(row);
  scrollToBottom();
}

function removeLoadingMessage() {
  const el = document.getElementById('loading-msg');
  if (el) el.remove();
}

/* â”€â”€ Regular Mode: test-format rendering â”€â”€ */

function renderRegularBot(data) {
  const { answer, citations } = data;

  // Build source cards (file + page) inside the bubble
  let sourcesHtml = '';
  if (citations && citations.length > 0) {
    sourcesHtml += '<div class="source-separator">××§×•×¨×•×ª</div>';
    sourcesHtml += citations.map(c => {
      const file = c.source_file_path || c.document_title || '';
      const page = c.page_number || 0;
      return `
        <div class="source-card">
          <div class="source-card-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
            </svg>
          </div>
          <div class="source-card-body">
            <div class="source-card-file">${escapeHtml(file)}</div>
            ${page ? `<div class="source-card-page">×¢××•×“ ${page}</div>` : ''}
          </div>
        </div>`;
    }).join('');
  }

  const row = document.createElement('div');
  row.className = 'msg-row bot';
  row.innerHTML = `
    <div class="msg-avatar">
      <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
      </svg>
    </div>
    <div class="msg-content">
      <div class="msg-bubble">
        ${formatAnswer(answer)}
        ${sourcesHtml}
      </div>
    </div>
  `;
  messagesEl.appendChild(row);
}

/* â”€â”€ Debug Mode: full response rendering â”€â”€ */

function renderDebugBot(data) {
  const { answer, citations, domain, confidence, retrieval_mode, navigation_path } = data;
  const domainInfo = domain && DOMAIN_MAP[domain];
  const confLevel = confidence >= 0.7 ? 'high' : confidence >= 0.4 ? 'medium' : 'low';
  const confLabel = confLevel === 'high' ? '×‘×™×˜×—×•×Ÿ ×’×‘×•×”' : confLevel === 'medium' ? '×‘×™×˜×—×•×Ÿ ×‘×™× ×•× ×™' : '×‘×™×˜×—×•×Ÿ × ××•×š';

  const modeLabels = { rag: 'RAG', agentic: 'Agentic', combined: 'Combined' };
  const mode = retrieval_mode || 'rag';

  const uid = Date.now() + Math.random().toString(36).slice(2, 6);
  const citationId = 'cit-' + uid;
  const traceId = 'trace-' + uid;
  const debugId = 'dbg-' + uid;

  let metaHtml = '<div class="msg-meta">';
  if (domainInfo) {
    metaHtml += `<span class="domain-badge"><span class="domain-icon">${domainInfo.icon}</span>${domainInfo.label}</span>`;
  }
  metaHtml += `<span class="confidence-tag ${confLevel}">${confLabel}</span>`;
  metaHtml += `<span class="mode-badge ${mode}">${modeLabels[mode] || mode}</span>`;
  metaHtml += '</div>';

  let citationsHtml = '';
  if (citations && citations.length > 0) {
    citationsHtml = `
      <button class="citations-toggle" onclick="togglePanel('${citationId}', this)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="6 9 12 15 18 9"/>
        </svg>
        ${citations.length} ××§×•×¨×•×ª
      </button>
      <div class="citations-panel" id="${citationId}">
        ${citations.map((c, i) => `
          <div class="citation-card">
            <div class="citation-num">${i + 1}</div>
            <div class="citation-body">
              <div class="citation-title">${escapeHtml(c.document_title || '××¡××š')}</div>
              ${c.source_file_path ? `<div class="citation-section" style="direction:ltr;text-align:right">${escapeHtml(c.source_file_path)}</div>` : ''}
              ${c.page_number ? `<div class="citation-section">×¢××•×“ ${c.page_number}</div>` : ''}
              ${c.section ? `<div class="citation-section">${escapeHtml(c.section)}</div>` : ''}
              ${c.relevant_text ? `<div class="citation-text">${escapeHtml(c.relevant_text)}</div>` : ''}
              ${c.source_url ? `<a class="citation-link" href="${escapeHtml(c.source_url)}" target="_blank" rel="noopener">×¤×ª×— ××§×•×¨ â†</a>` : ''}
            </div>
          </div>
        `).join('')}
      </div>
    `;
  }

  // Navigation trace
  let traceHtml = '';
  if (navigation_path && navigation_path.trace && navigation_path.trace.length > 0) {
    const stepIcons = { '1': '\u{1F4DA}', '2': '\u{1F4C4}', '3': '\u{1F4D1}', '4': '\u{1F9E9}' };
    const steps = navigation_path.trace.map((t, i) => {
      const num = String(i + 1);
      const icon = stepIcons[num] || '\u{25B6}';
      return `<div class="nav-trace-step"><span class="step-icon">${icon}</span>${escapeHtml(t)}</div>`;
    }).join('');
    traceHtml = `
      <button class="nav-trace-toggle" onclick="togglePanel('${traceId}', this)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="6 9 12 15 18 9"/>
        </svg>
        Navigation trace (${navigation_path.trace.length} steps)
      </button>
      <div class="nav-trace-panel" id="${traceId}">
        ${steps}
      </div>
    `;
  }

  // Raw JSON debug panel
  const debugJson = JSON.stringify(data, null, 2);
  const debugHtml = `
    <button class="debug-toggle" onclick="togglePanel('${debugId}', this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="6 9 12 15 18 9"/>
      </svg>
      Raw JSON
    </button>
    <div class="debug-panel" id="${debugId}">
      <div class="debug-json">${escapeHtml(debugJson)}</div>
    </div>
  `;

  const row = document.createElement('div');
  row.className = 'msg-row bot';
  row.innerHTML = `
    <div class="msg-avatar">
      <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
      </svg>
    </div>
    <div class="msg-content">
      <div class="msg-bubble">${formatAnswer(answer)}</div>
      ${metaHtml}
      ${citationsHtml}
      ${traceHtml}
      ${debugHtml}
    </div>
  `;
  messagesEl.appendChild(row);
}

/* â”€â”€ Dispatch to correct renderer â”€â”€ */

function renderBotMessage(data) {
  if (viewMode === 'debug') {
    renderDebugBot(data);
  } else {
    renderRegularBot(data);
  }
}

function addBotMessage(data) {
  removeLoadingMessage();
  messageStore.push({ type: 'bot', data });
  renderBotMessage(data);
  scrollToBottom();
}

/* â”€â”€ Generic toggle for collapsible panels â”€â”€ */

function togglePanel(id, btn) {
  const panel = document.getElementById(id);
  panel.classList.toggle('open');
  btn.classList.toggle('open');
}

// Keep old names as aliases for any existing inline handlers
function toggleCitations(id, btn) { togglePanel(id, btn); }
function toggleNavTrace(id, btn) { togglePanel(id, btn); }

/* â”€â”€ Send Message â”€â”€ */

async function sendMessage() {
  const text = input.value.trim();
  if (!text || isLoading) return;

  isLoading = true;
  input.value = '';
  input.style.height = 'auto';
  sendBtn.disabled = true;

  // Build message with optional domain hint
  let message = text;
  if (selectedDomain) {
    const info = DOMAIN_MAP[selectedDomain];
    message = `[×ª×—×•×: ${info.label}] ${text}`;
  }

  addUserMessage(text);
  addLoadingMessage();

  // Clear domain selection after sending
  selectedDomain = null;
  updateDomainTag();

  // Start 30s patience timer
  patienceTimer = setTimeout(() => {
    const loadingEl = document.getElementById('loading-msg');
    if (loadingEl) {
      const bubble = loadingEl.querySelector('.msg-bubble');
      if (bubble) {
        bubble.innerHTML = '<div style="font-size:13.5px">×ª×•×“×” ×¢×œ ×”×¤× ×™×™×”, ×× ×™ ×‘×•×“×§ ×¢×‘×•×¨×š...</div><div class="typing-dots" style="margin-top:6px"><span></span><span></span><span></span></div>';
        scrollToBottom();
      }
    }
  }, 30000);

  try {
    const res = await fetch(`${API_URL}/chat`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: message,
        conversation_id: conversationId,
      }),
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const data = await res.json();
    conversationId = data.conversation_id;
    addBotMessage(data);
  } catch (err) {
    removeLoadingMessage();
    addBotMessage({
      answer: '××¦×˜×¢×¨, ××™×¨×¢×” ×©×’×™××” ×‘×¢×™×‘×•×“ ×”×‘×§×©×”. ×× × × ×¡×• ×©×•×‘.',
      citations: [],
      domain: null,
      confidence: 0,
    });
    console.error('Chat error:', err);
  } finally {
    clearTimeout(patienceTimer);
    patienceTimer = null;
    isLoading = false;
    sendBtn.disabled = !input.value.trim();
    input.focus();
  }
}
</script>
</body>
</html>
